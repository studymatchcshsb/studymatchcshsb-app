<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Study Dashboard</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    /* CSHSB Green Theme */
    .sidebar {
      background: linear-gradient(180deg, #FFCF50 0%, #347433 100%);
    }
    
    .sidebar .icon {
      color: white;
    }
    
    .sidebar .icon:hover {
      color: #FFF;
    }
    
    .dashboard-header {
      background: linear-gradient(90deg, #FFCF50 0%, #347433 100%);
    }
    
    .header-icons .icon {
      color: white;
    }
    
    .header-icons .icon:hover {
      color: #FFF;
    }
    
    .profile-initials {
      background: linear-gradient(135deg, #FFCF50, #347433) !important;
      color: white !important;
    }
    
    .header-username {
      color: white;
      font-weight: 600;
    }
    
    /* Notification styles */
    .notification-bell-container {
      position: relative;
      display: inline-block;
    }
    
    .notification-dot {
      position: absolute;
      top: -2px;
      right: -2px;
      width: 12px;
      height: 12px;
      background-color: #e74c3c;
      border-radius: 50%;
      border: 2px solid white;
      display: none;
      z-index: 10;
      animation: pulse 2s infinite;
    }
    
    .notification-dot.active {
      display: block;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
      70% { transform: scale(1.1); box-shadow: 0 0 0 6px rgba(231, 76, 60, 0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
    }
    
    .notification-item {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      border-left: 4px solid #c1dcba;
    }
    
    .notification-item.kastudy_accepted {
      border-left-color: #FFCF50;
    }
    
    .help-btn.yes-btn {
      background: linear-gradient(45deg, #c1dcba, #d4e8d1);
    }
    
    .help-btn.no-btn {
      background: #c0392b;
    }

    /* Weekly Recommendations Modal */
    #weekly-recommendations-modal .modal-content {
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
    }
  </style>
</head>
<body>
 <div class="dashboard-container">
    <aside class="sidebar">
      <!-- Active Users Icon -->
      <svg class="icon" onclick="window.location.href='/active-users.html'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
      <!-- Hamburger Menu Icon -->
      <svg class="icon" onclick="toggleMenu()" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
      <!-- Help/Question Icon -->
      <svg id="help-icon" class="icon" onclick="openHelpModal()" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>
    </aside>

    <div id="menu-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close-btn" onclick="toggleMenu()">&times;</span>
            <h3><b>Password and Security</b></h3>
            <p>Gmail: <span id="menu-email"></span></p>
            <p>Password: ******** <button onclick="openChangePasswordModal()">Change</button></p>
            <hr>
            <button onclick="logout()">Log Out</button>
        </div>
    </div>

    <div id="change-password-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close-btn" onclick="closeChangePasswordModal()">&times;</span>
            <h3>Change Password</h3>
            <input type="password" id="current-password" placeholder="Current Password">
            <input type="password" id="new-password" placeholder="New Password">
            <input type="password" id="confirm-new-password" placeholder="Confirm New Password" oninput="validateNewPasswords()">
            <p id="password-validation-message" style="margin: 5px 0; font-size: 0.9em;"></p>
            <button onclick="changePassword()">Save Changes</button>
            <p id="change-password-message" style="color: red;"></p>
        </div>
    </div>

    <div class="main-content">
      <header class="dashboard-header">
        <div class="header-icons">
          <div class="notification-bell-container" onclick="openNotificationsModal()">
            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg>
            <span id="notification-dot" class="notification-dot"></span>
          </div>
          <svg class="icon" onclick="window.location.href='/chats.html'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
          <svg class="icon" onclick="openWeeklyRecommendations()" title="Weekly Study Partner Recommendations" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3L1 9l4 2.18v6L12 21l7-3.82v-6l2-1.09V17h2V9L12 3zm6.82 6L12 12.72 5.18 9 12 5.28 18.82 9zM17 15.99l-5 2.73-5-2.73v-3.72L12 15l5-2.73v3.72z"/></svg>
        </div>


        <a href="/profile.html" class="header-profile">
          <div class="profile-initials" id="profile-initials"></div>
          <span id="user-name" class="header-username"></span>
        </a>
      </header>

      <main class="dashboard-main">
        <section class="todo-section">
          <div class="list-box" id="todo-list-container">
            <!-- To-do items will be dynamically inserted here -->
          </div>
          <button class="add-list-btn" onclick="openTodoModal()">+</button>
        </section>

        <!-- Profile Completion Reminder -->
        <div id="profile-reminder" class="profile-reminder" style="display: none;">
          <div class="reminder-content">
            <div class="reminder-icon">üìù</div>
            <div class="reminder-text">
              <strong>STUDYMATCH CSHSB:</strong> Finish setting up your profile by updating the subjects you are good at and need help with. You can see this through clicking your profile at the top right corner of your Homepage.
            </div>
          </div>
        </div>

        <!-- Add To-Do Modal -->
        <div id="todo-modal" class="modal" style="display:none;">
          <div class="modal-content">
            <span class="close-btn" onclick="closeTodoModal()">&times;</span>
            <h3>Add New To-Do</h3>
            <input type="text" id="todo-title" placeholder="Title (e.g., Quizzes)">
            <textarea id="todo-items" placeholder="Items (one per line)"></textarea>
            <button onclick="addTodo()">Add To-Do</button>
          </div>
        </div>
      </main>

      <!-- Find a KaStudy - Simplified -->
      <section class="find-kastudy-corner">
        <div class="find-content">
          <div class="speech-bubble">Find a KaStudy!</div>
          <div class="find-form">
            <select id="quick-grade" onchange="updateQuickSubject()">
              <option value="">Select Grade</option>
              <option value="7">Grade 7</option>
              <option value="8">Grade 8</option>
              <option value="9">Grade 9</option>
              <option value="10">Grade 10</option>
            </select>
            <select id="quick-subject">
              <option value="">Select Subject</option>
              <option value="ENGLISH">ENGLISH</option>
              <option value="FILIPINO">FILIPINO</option>
              <option value="SCIENCE">SCIENCE</option>
              <option value="MATH">MATH</option>
              <option value="ESP">ESP</option>
              <option value="AP">AP</option>
              <option value="ICT">ICT</option>
              <option value="MAPEH">MAPEH</option>
            </select>
            <button class="find-btn" onclick="quickFindKaStudy()">Find!</button>
          </div>
          <p id="quick-result" style="text-align: center; margin-top: 10px; font-size: 12px;"></p>
        </div>
      </section>


  <!-- Notifications Modal -->
  <div id="notifications-modal" class="modal" style="display:none;">
      <div class="modal-content">
          <span class="close-btn" onclick="closeNotificationsModal()">&times;</span>
          <h3><b>StudyMatch CSHSB</b></h3>
          <div id="notifications-list">
              <!-- Notifications will be loaded here -->
          </div>
          <div id="no-notifications" style="text-align: center; color: #666; padding: 20px;">
              <p>No notifications yet.</p>
              <p>Help requests from classmates will appear here!</p>
          </div>
      </div>
  </div>

  <!-- Weekly Recommendations Modal -->
  <div id="weekly-recommendations-modal" class="modal" style="display:none;">
      <div class="modal-content">
          <span class="close-btn" onclick="closeWeeklyRecommendations()">&times;</span>
          <h3><b>üìÖ Weekly Study Partner Recommendations</b></h3>
          <p style="color: #666; margin-bottom: 20px;">Based on your profile and subjects, here are recommended study partners for you:</p>
          <div id="weekly-recommendations-list">
              <!-- Recommendations will be loaded here -->
          </div>
          <div id="no-recommendations" style="text-align: center; color: #666; padding: 20px; display: none;">
              <p>No recommendations available yet.</p>
              <p>Make sure you've completed your profile with strengths and weaknesses!</p>
          </div>
      </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
  const backendURL = window.location.origin;
  const socket = io();
  
  // Track unread notifications count
  let unreadCount = 0;
  let currentUserIsAdmin = false;

  // Check if user is logged in on page load
  async function checkAuthentication() {
    try {
      const response = await fetch(`${backendURL}/check-session`, {
        method: 'GET',
        credentials: 'include'
      });

      if (!response.ok) {
        // Not authenticated, redirect to login
        window.location.href = '/index.html';
        return;
      }

      const data = await response.json();
      if (!data.loggedIn) {
        // Not authenticated, redirect to login
        window.location.href = '/index.html';
        return;
      }

      // Check if profile is complete
      if (!data.profileComplete) {
        // Profile not complete, redirect to profile setup
        window.location.href = '/profile-setup.html';
        return;
      }

      // User is authenticated and profile is complete, continue with page load
      console.log('User authenticated:', data.email);
    } catch (error) {
      console.log('Authentication check failed:', error);
      // On error, redirect to login to be safe
      window.location.href = '/index.html';
    }
  }

    function openTodoModal() {
      document.getElementById('todo-modal').style.display = 'block';
    }

    function closeTodoModal() {
      document.getElementById('todo-modal').style.display = 'none';
    }

    function openHelpModal() {
      document.getElementById('help-modal').style.display = 'block';
    }

    function closeHelpModal() {
      document.getElementById('help-modal').style.display = 'none';
    }

    async function toggleMenu() {
        const menu = document.getElementById('menu-modal');
        if (menu.style.display === 'block') {
            menu.style.display = 'none';
        } else {
            try {
              const response = await fetch(`${backendURL}/get-profile`, {
                credentials: 'include'
              });
              if (!response.ok) {
                throw new Error('Failed to fetch profile');
              }
              const data = await response.json();
              if (data.success) {
                document.getElementById('menu-email').innerText = data.user.email;
              }
            } catch (error) {
              console.error("Error fetching profile:", error);
            }
            menu.style.display = 'block';
        }
    }

    function openChangePasswordModal() {
        document.getElementById('change-password-modal').style.display = 'block';
    }

    function closeChangePasswordModal() {
        document.getElementById('change-password-modal').style.display = 'none';
    }

    async function fetchTodos() {
      console.log('fetchTodos() called');
      try {
        const response = await fetch(`${backendURL}/get-todos`, {
          credentials: 'include'
        });
        console.log('Fetch todos response status:', response.status);
        if (!response.ok) {
          throw new Error('Failed to fetch to-dos.');
        }
        const todos = await response.json();
        console.log('Fetched todos:', todos);
        const container = document.getElementById('todo-list-container');
        container.innerHTML = ''; // Clear existing todos
        todos.forEach(todo => {
          const todoEl = document.createElement('div');
          todoEl.className = 'todo-item';
          todoEl.innerHTML = `
            <h3>
              ${todo.title}
              <span class="delete-btn" onclick="deleteTodo('${todo._id}')">&times;</span>
            </h3>
            <p>${Array.isArray(todo.items) ? todo.items.join('<br>') : ''}</p>
          `;
          container.appendChild(todoEl);
        });
      } catch (error) {
        console.error("Error fetching todos:", error);
        // Optionally show an error to the user
      }
    }

    async function addTodo() {
      const title = document.getElementById('todo-title').value;
      const items = document.getElementById('todo-items').value.split('\n').filter(item => item.trim() !== '');

      if (!title || items.length === 0) {
        alert("Please provide a title and at least one item.");
        return;
      }

      try {
        const response = await fetch(`${backendURL}/add-todo`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ title, items })
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Failed to add to-do');
        }

        closeTodoModal();
        fetchTodos(); // Refresh the list
      } catch (error) {
        console.error("Error adding todo:", error);
        alert(`Error: ${error.message}`);
      }
    }
  
    async function deleteTodo(id) {
      if (!confirm("Are you sure you want to delete this to-do list?")) {
        return;
      }
  
      try {
        const response = await fetch(`${backendURL}/delete-todo/${id}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Failed to delete to-do');
        }
        fetchTodos(); // Refresh the list
      } catch (error) {
        console.error("Error deleting todo:", error);
        alert(`Error: ${error.message}`);
      }
    }
  
    async function submitHelpRequest() {
      const message = document.getElementById('help-request').value;
      if (!message.trim()) {
        alert('Please enter your query or suggestion.');
        return;
      }
  
      try {
        const response = await fetch(`${backendURL}/send-help-request`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });
  
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Failed to send help request.');
        }
  
        document.getElementById('help-request').value = '';
        const helpMessageEl = document.getElementById('help-message');
        helpMessageEl.innerText = "Thank you for letting us know. We'll get back to you with an update. Kindly check your email address for our response.";
        setTimeout(() => {
          closeHelpModal();
          helpMessageEl.innerText = '';
        }, 5000);
  
      } catch (error) {
        console.error("Error sending help request:", error);
        alert(`Error: ${error.message}`);
      }
    }

    function validateNewPasswords() {
        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-new-password').value;
        const messageEl = document.getElementById('password-validation-message');
        const confirmInput = document.getElementById('confirm-new-password');

        if (confirmPassword === '') {
            messageEl.innerText = '';
            confirmInput.style.borderColor = '';
            return;
        }

        if (newPassword === confirmPassword) {
            messageEl.innerText = '‚úì Passwords match!';
            messageEl.style.color = 'green';
            confirmInput.style.borderColor = 'green';
        } else {
            messageEl.innerText = '‚úó Passwords do not match';
            messageEl.style.color = 'red';
            confirmInput.style.borderColor = 'red';
        }
    }

    async function changePassword() {
        const currentPassword = document.getElementById('current-password').value;
        const newPassword = document.getElementById('new-password').value;
        const confirmNewPassword = document.getElementById('confirm-new-password').value;
        const messageEl = document.getElementById('change-password-message');

        if (newPassword !== confirmNewPassword) {
            messageEl.innerText = "New passwords do not match.";
            return;
        }

        try {
            const response = await fetch(`${backendURL}/change-password`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ currentPassword, newPassword })
            });

            const data = await response.json();

            if (data.success) {
                messageEl.style.color = 'green';
                messageEl.innerText = "Password changed successfully!";
                setTimeout(() => {
                    closeChangePasswordModal();
                    messageEl.innerText = '';
                    messageEl.style.color = 'red';
                }, 2000);
            } else {
                messageEl.innerText = data.message;
            }
        } catch (error) {
            console.error("Error changing password:", error);
            messageEl.innerText = "An error occurred. Please try again.";
        }
    }

    async function logout() {
        if (confirm("Save password for future log-ins?")) {
            console.log("User chose to save password.");
            // Password is already saved in localStorage from login
        } else {
            console.log("User chose not to save password.");
            localStorage.removeItem('savedEmail');
            localStorage.removeItem('savedPassword');
        }

        try {
            await fetch(`${backendURL}/logout`, { method: 'POST' });
            window.location.href = '/index.html';
        } catch (error) {
            console.error("Error logging out:", error);
        }
    }

    // Simplified Find KaStudy function
    async function quickFindKaStudy() {
        const grade = document.getElementById('quick-grade').value;
        const subject = document.getElementById('quick-subject').value;
        const resultEl = document.getElementById('quick-result');
        
        // Client-side profanity check
        const inappropriateWords = ['fuck', 'fuk', 'fck', 'fucku', 'fcku', 'fuk u', 'fuck you', 'fuckyou', 'shit', 'shyt', 'sh1t', 'shitty', 'ass', 'azz', 'as5', 'a55', 'butt', 'bitch', 'b1tch', 'bich', 'bitxh', 'btch', 'bastard', 'bastrd', 'baster', 'damn', 'damnit', 'dammit', 'hell', 'hellno', 'hell no', 'crap', 'crappy', 'dick', 'd1ck', 'dik', 'piss', 'p1ss', 'cock', 'c0ck', 'cok', 'cunt', 'c0nt', 'whore', 'whor3', 'slut', 'sl1ut', '5lut', 'gay', 'g4y', 'faggot', 'fagg0t', 'fagot', 'retard', 'ret1rd', 'retarded', 'idiot', '1d1ot', 'stupid', 'st00pid', 'ugly', 'ug1y', 'hate', 'hat3', 'loser', 'l0ser', 'dumb', 'dumbass', 'porn', 'p0rn', 'pr0n', 'xxx', 'sex', 's3x', 'nude', 'n00d', 'nipple', 'nipples', 'vagina', 'vajina', 'pussy', 'pusssy', 'penis', 'p3nis', 'boob', 'boobs', 'tits', 'tit'];
        
        function containsInappropriateWords(text) {
          if (!text) return false;
          const lowerText = text.toLowerCase();
          return inappropriateWords.some(word => lowerText.includes(word));
        }
        
        console.log('quickFindKaStudy called - grade:', grade, 'subject:', subject);
        
        // Check for inappropriate words
        if (containsInappropriateWords(subject)) {
            resultEl.innerText = 'Please use appropriate language for the subject.';
            resultEl.style.color = 'red';
            return;
        }
        
        if (!grade) {
            resultEl.innerText = 'Please select a grade level.';
            resultEl.style.color = 'red';
            return;
        }
        
        if (!subject) {
            resultEl.innerText = 'Please select a subject.';
            resultEl.style.color = 'red';
            return;
        }
        
        resultEl.innerText = 'Sending...';
        resultEl.style.color = 'blue';
        
        try {
            const response = await fetch(`${backendURL}/find-kastudy`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    grade: parseInt(grade),
                    subject: subject
                }),
                credentials: 'include'
            });

            const data = await response.json();
            
            if (response.ok) {
                resultEl.innerText = data.message;
                resultEl.style.color = 'green';
                alert(data.message);
            } else {
                resultEl.innerText = 'Error: ' + data.message;
                resultEl.style.color = 'red';
                alert('Error: ' + data.message);
            }
        } catch (error) {
            console.error('Error:', error);
            resultEl.innerText = 'Network error: ' + error.message;
            resultEl.style.color = 'red';
        }
    }

    // Old modal-based functions (kept for reference but not used)
    let selectedGrade = null;
    let selectedSubject = null;

    function openGradeModal() {
        document.getElementById('grade-modal').style.display = 'block';
    }

    function closeGradeModal() {
        document.getElementById('grade-modal').style.display = 'none';
    }

    function selectGrade(grade) {
        selectedGrade = grade;
        document.getElementById('selected-grade').value = grade;
        document.getElementById('grade-display').innerText = 'Selected: Grade ' + grade;
        closeGradeModal();
        openSubjectModal();
    }

    function openSubjectModal() {
        document.getElementById('subject-modal').style.display = 'block';
    }

    function closeSubjectModal() {
        document.getElementById('subject-modal').style.display = 'none';
    }

    function selectSubject(subject) {
        selectedSubject = subject;
        document.getElementById('selected-subject').value = subject;
        document.getElementById('subject-display').innerText = 'Selected Subject: ' + subject;
        closeSubjectModal();
        openConfirmationModal();
    }

    function openConfirmationModal() {
        document.getElementById('confirmation-modal').style.display = 'block';
        const grade = document.getElementById('selected-grade').value;
        const subject = document.getElementById('selected-subject').value;
        document.getElementById('confirmation-display').innerText = 'Grade ' + grade + ' - ' + subject;
    }

    function closeConfirmationModal() {
        document.getElementById('confirmation-modal').style.display = 'none';
    }

    async function confirmFind(yes) {
        if (yes) {
            const grade = document.getElementById('selected-grade').value;
            const subject = document.getElementById('selected-subject').value;
            
            if (!grade || !subject) {
                alert('Please select both grade level and subject.');
                return;
            }
            
            closeConfirmationModal();
            
            try {
                const response = await fetch(`${backendURL}/find-kastudy`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        grade: parseInt(grade),
                        subject: subject
                    }),
                    credentials: 'include'
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to send help request');
                }

                const data = await response.json();
                alert(data.message || 'Help request sent successfully!');
                selectedGrade = null;
                selectedSubject = null;
            } catch (error) {
                console.error('Error sending help request:', error);
                alert('Error sending help request. Please try again. Error: ' + error.message);
            }
        } else {
            closeConfirmationModal();
            closeGradeModal();
            closeSubjectModal();
            selectedGrade = null;
            selectedSubject = null;
        }
    }

    function openSearchingModal() {
        document.getElementById('searching-modal').style.display = 'block';
    }


    function openNotificationsModal() {
        document.getElementById('notifications-modal').style.display = 'block';
        loadNotifications();
    }

    function closeNotificationsModal() {
        document.getElementById('notifications-modal').style.display = 'none';
    }

    // Weekly Recommendations functions
    function openWeeklyRecommendations() {
        document.getElementById('weekly-recommendations-modal').style.display = 'block';
        loadWeeklyRecommendations();
    }

    function closeWeeklyRecommendations() {
        document.getElementById('weekly-recommendations-modal').style.display = 'none';
    }

    async function loadWeeklyRecommendations() {
        try {
            const response = await fetch(`${backendURL}/get-weekly-recommendations`);
            if (!response.ok) throw new Error('Failed to fetch recommendations');
            
            const data = await response.json();
            
            if (data.success) {
                displayWeeklyRecommendations(data);
            }
        } catch (error) {
            console.error("Error loading recommendations:", error);
            document.getElementById('weekly-recommendations-list').innerHTML = 
                '<div style="text-align: center; color: #666; padding: 20px;">Failed to load recommendations.</div>';
        }
    }

    function displayWeeklyRecommendations(data) {
        const container = document.getElementById('weekly-recommendations-list');
        const noRec = document.getElementById('no-recommendations');

        if (!data.recommendations || data.recommendations.length === 0) {
            container.innerHTML = '';
            noRec.style.display = 'block';
            noRec.innerHTML = `<p>${data.message || 'No recommendations available yet.'}</p>`;
            return;
        }

        noRec.style.display = 'none';
        let html = `<p style="color: #1B5E20; font-weight: bold; margin-bottom: 15px;">You've been with StudyMatch for ${data.weeksActive} week(s)! Here are your matched study partners:</p>`;
        
        data.recommendations.forEach((rec, index) => {
            const matchReasons = [];
            if (rec.canHelpYou > 0) {
                matchReasons.push(`Can help you with: ${rec.strengths.filter(s => (data.userWeaknesses || []).includes(s)).slice(0, 3).join(', ')}`);
            }
            if (rec.youCanHelp > 0) {
                matchReasons.push(`You can help with: ${rec.weaknesses.filter(w => (data.userStrengths || []).includes(w)).slice(0, 3).join(', ')}`);
            }
            
            html += `
                <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin-bottom: 15px; border-left: 4px solid #347433;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>
                            <strong style="font-size: 16px; color: #1B5E20;">${rec.name} ${rec.surname}</strong>
                            <span style="color: #666; margin-left: 10px;">@${rec.username}</span>
                        </div>
                        <span style="background: #c1dcba; color: #347433; padding: 5px 12px; border-radius: 15px; font-size: 12px; font-weight: bold;">Match Score: ${rec.score}</span>
                    </div>
                    <div style="font-size: 13px; color: #666;">
                        <div><strong>Their Strengths:</strong> ${rec.strengths.join(', ') || 'Not set'}</div>
                        <div><strong>Needs Help With:</strong> ${rec.weaknesses.join(', ') || 'Not set'}</div>
                    </div>
                    <button onclick="requestAsStudyPartner('${rec.email}', '${rec.username}')" style="margin-top: 10px; width: 100%; padding: 10px; background: linear-gradient(135deg, #82E0AA, #ABEBC6); color: #1B5E20; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                        ü§ù Request as Study Partner
                    </button>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    async function requestAsStudyPartner(email, username) {
        if (!confirm(`Request ${username} as your study partner?`)) return;
        
        try {
            const response = await fetch(`${backendURL}/find-kastudy`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    grade: parseInt(document.getElementById('quick-grade')?.value || 7),
                    subject: 'STUDY_PARTNER'
                }),
                credentials: 'include'
            });

            const data = await response.json();
            alert(data.message || 'Study partner request sent!');
        } catch (error) {
            console.error('Error requesting study partner:', error);
            alert('Failed to send request. Please try again.');
        }
    }

    // Update the notification dot visibility
    function updateNotificationDot(count) {
        const dot = document.getElementById('notification-dot');
        if (count > 0) {
            dot.classList.add('active');
        } else {
            dot.classList.remove('active');
        }
    }

    // Load notifications
    async function loadNotifications() {
        try {
            const response = await fetch(`${backendURL}/get-notifications`, {
                credentials: 'include'
            });
            if (!response.ok) {
                throw new Error('Failed to fetch notifications');
            }
            const data = await response.json();
            const notifications = data.notifications || [];
            
            // Update notification count and dot
            unreadCount = notifications.length;
            updateNotificationDot(unreadCount);
            
            displayNotifications(notifications);
        } catch (error) {
            console.error("Error loading notifications:", error);
        }
    }

    // Display notifications in the modal
    function displayNotifications(notifications) {
        const container = document.getElementById('notifications-list');
        const noNotifications = document.getElementById('no-notifications');

        if (notifications.length === 0) {
            container.innerHTML = '';
            noNotifications.style.display = 'block';
            return;
        }

        noNotifications.style.display = 'none';
        container.innerHTML = '';

        notifications.forEach(notification => {
            if (notification.type === 'help_request') {
                const notificationDiv = document.createElement('div');
                notificationDiv.className = 'notification-item';
                notificationDiv.innerHTML = `
                    <div class="notification-content">
                        <strong>STUDYMATCH CSHSB</strong><br>
                        ${notification.message}
                    </div>
                    <div class="notification-actions">
                        <button class="help-btn yes-btn" onclick="respondToHelpRequest('${notification.id}', 'accept', '${notification.fromUser.email}', '${notification.subject}')">Yes</button>
                        <button class="help-btn no-btn" onclick="respondToHelpRequest('${notification.id}', 'decline')">No</button>
                    </div>
                `;
                container.appendChild(notificationDiv);
            } else if (notification.type === 'kastudy_request') {
                const notificationDiv = document.createElement('div');
                notificationDiv.className = 'notification-item';
                notificationDiv.innerHTML = `
                    <div class="notification-content">
                        <strong>STUDYMATCH CSHSB</strong><br>
                        ${notification.message}
                    </div>
                    <div class="notification-actions">
                        <button class="help-btn yes-btn" onclick="respondToKastudyRequest('${notification.id}', 'accept', '${notification.fromUser.email}', '${notification.subject}', '${notification.fromUser.username || ''}')">Yes</button>
                        <button class="help-btn no-btn" onclick="respondToKastudyRequest('${notification.id}', 'decline')">No</button>
                    </div>
                `;
                container.appendChild(notificationDiv);
            } else if (notification.type === 'kastudy_accepted') {
                const notificationDiv = document.createElement('div');
                notificationDiv.className = 'notification-item kastudy_accepted';
                const chatUrl = notification.redirectUrl || '/chats.html?chat=' + encodeURIComponent(notification.fromUser.email);
                notificationDiv.innerHTML = `
                    <div class="notification-content">
                        <strong>STUDYMATCH CSHSB</strong><br>
                        ${notification.message}
                    </div>
                    <div class="notification-actions">
                        <button class="help-btn yes-btn" onclick="window.location.href='${chatUrl}'" style="width: 100%; background: #3498db; color: white;">Start Chatting</button>
                    </div>
                `;
                container.appendChild(notificationDiv);
            }
        });
    }

    // Handle help request response
    async function respondToHelpRequest(notificationId, response, requesterEmail, subject, requesterName) {
        // Immediately remove the notification element from the UI
        const notificationElements = document.querySelectorAll('.notification-item');
        notificationElements.forEach(el => {
            if (el.innerHTML.includes(notificationId)) {
                el.remove();
            }
        });
        
        // Also check and update no-notifications div
        const remainingNotifications = document.querySelectorAll('.notification-item');
        if (remainingNotifications.length === 0) {
            document.getElementById('no-notifications').style.display = 'block';
        }
        
        try {
            const responseData = await fetch(`${backendURL}/respond-help-request`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    notificationId,
                    response,
                    requesterEmail,
                    subject,
                    requesterName
                })
            });

            if (!responseData.ok) {
                throw new Error('Failed to respond to help request');
            }

            const data = await responseData.json();

            if (response === 'accept') {
                alert(data.message);
                // Redirect to chats page with the requester's email
                window.location.href = data.redirectUrl || '/chats.html?chat=' + encodeURIComponent(requesterEmail);
            } else {
                // Reload to ensure the notification is removed
                loadNotifications();
            }
        } catch (error) {
            console.error("Error responding to help request:", error);
            alert('Error processing your response. Please try again.');
        }
    }


    // Handle kastudy request response
    async function respondToKastudyRequest(notificationId, response, requesterEmail, subject, requesterName) {
        // Immediately remove the notification element from the UI
        const notificationElements = document.querySelectorAll('.notification-item');
        notificationElements.forEach(el => {
            if (el.innerHTML.includes(notificationId)) {
                el.remove();
            }
        });
        
        // Also check and update no-notifications div
        const remainingNotifications = document.querySelectorAll('.notification-item');
        if (remainingNotifications.length === 0) {
            document.getElementById('no-notifications').style.display = 'block';
        }
        
        try {
            const responseData = await fetch(`${backendURL}/respond-kastudy-request`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    notificationId,
                    response,
                    requesterEmail,
                    subject,
                    requesterName
                })
            });

            if (!responseData.ok) {
                throw new Error('Failed to respond to kastudy request');
            }

            const data = await responseData.json();

            if (response === 'accept') {
                alert(data.message);
                // Redirect to chats page with the requester's email
                window.location.href = data.redirectUrl || '/chats.html?chat=' + encodeURIComponent(requesterEmail);
            } else {
                // Reload to ensure the notification is removed
                loadNotifications();
            }
        } catch (error) {
            console.error("Error responding to kastudy request:", error);
            alert('Error processing your response. Please try again.');
        }
    }


    // Fetch user profile and set initials
    async function fetchUserProfile() {
      try {
        const response = await fetch(`${backendURL}/get-profile`, {
        credentials: 'include'
      });
        if (!response.ok) {
          throw new Error('Failed to fetch profile');
        }
        const data = await response.json();
        if (data.success) {
          console.log('User profile loaded:', data.user);
          // Set username beside profile circle
          document.getElementById('user-name').innerText = data.user.username;

          // Set profile initials
          const initials = data.user.username.charAt(0).toUpperCase();
          document.getElementById('profile-initials').innerText = initials;
          
          // Check if user is admin and hide help icon
          currentUserIsAdmin = data.user.isAdmin || false;
          if (currentUserIsAdmin) {
            document.getElementById('help-icon').style.display = 'none';
            // Also hide the Find a KaStudy section for admins
            const findKaStudySection = document.querySelector('.find-kastudy-corner');
            if (findKaStudySection) {
              findKaStudySection.style.display = 'none';
            }
          }

          // Join socket room for real-time notifications
          joinSocketRoom(data.user.email);

          // Check profile completion status
          checkProfileCompletion(data.user);
          
          // Load notifications and show dot if there are any
          loadNotifications();
        }
      } catch (error) {
        console.error("Error fetching profile:", error);
      }
    }

    // Check if user has completed their profile (has strengths and weaknesses)
    function checkProfileCompletion(user) {
      const reminder = document.getElementById('profile-reminder');

      // Show reminder if user doesn't have strengths or weaknesses set
      if (!user.strengths || user.strengths.length === 0 || !user.weaknesses || user.weaknesses.length === 0) {
        reminder.style.display = 'block';
      } else {
        reminder.style.display = 'none';
      }
    }

    // Fetch todos and user profile when the page loads
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('DOMContentLoaded - starting auth check');
      try {
        await checkAuthentication();
        console.log('Auth check passed, fetching todos and profile');
        fetchTodos();
        fetchUserProfile();
        // Start polling for notifications as backup
        startNotificationPolling();
      } catch (error) {
        console.error('Error in DOMContentLoaded:', error);
      }
    });

    // Socket.io event listeners for real-time notifications
    socket.on('new_notification', (notification) => {
      console.log('New notification received:', notification);
      
      // Increment unread count and show dot
      unreadCount++;
      updateNotificationDot(unreadCount);
      
      // Show a prominent toast notification
      showNotificationToast(notification);
      
      // Reload notifications if modal is open
      if (document.getElementById('notifications-modal').style.display === 'block') {
        loadNotifications();
      }
    });

    // Show toast notification
    function showNotificationToast(notification) {
      // Create toast element
      const toast = document.createElement('div');
      toast.className = 'notification-toast';
      toast.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
          <div style="background: #3498db; color: white; padding: 10px; border-radius: 50%;">üì¢</div>
          <div>
            <strong>New Help Request!</strong><br>
            <small>${notification.fromUser.username} needs help with ${notification.subject}</small>
          </div>
        </div>
      `;
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        border-left: 4px solid #3498db;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        max-width: 300px;
        animation: slideIn 0.3s ease-out;
        cursor: pointer;
      `;
      
      toast.onclick = function() {
        openNotificationsModal();
        document.body.removeChild(toast);
      };
      
      document.body.appendChild(toast);
      
      // Auto-remove after 8 seconds
      setTimeout(() => {
        if (toast.parentElement) {
          toast.style.animation = 'slideOut 0.3s ease-out';
          setTimeout(() => toast.remove(), 300);
        }
      }, 8000);
    }

    // Add animation styles for toast
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    `;
    document.head.appendChild(style);

    socket.on('help_request_accepted', (data) => {
      console.log('Help request accepted:', data);
      alert(`Someone accepted your help request for ${data.subject}! Check your chats.`);
      // Redirect to chats page
      setTimeout(() => {
        window.location.href = '/chats.html';
      }, 2000);
    });

    // Poll for notifications every 5 seconds as backup for socket.io
    function startNotificationPolling() {
      setInterval(() => {
        loadNotifications();
      }, 5000);
    }

    // Join socket room when user profile is loaded
    function joinSocketRoom(email) {
      socket.emit('join', email);
    }
  </script>
</body>
</html>
