<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, minimum-scale=0.5">
  <title>Study Dashboard</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    /* CSHSB Green Theme */
    .sidebar {
      background: linear-gradient(180deg, #FFCF50 0%, #347433 100%);
    }
    
    .sidebar .icon {
      color: white;
    }
    
    .sidebar .icon:hover {
      color: #FFF;
    }
    
    .dashboard-header {
      background: linear-gradient(90deg, #FFCF50 0%, #347433 100%);
    }
    
    .header-icons .icon {
      color: white;
    }
    
    .header-icons .icon:hover {
      color: #FFF;
    }
    
    .profile-initials {
      background: linear-gradient(135deg, #FFCF50, #347433) !important;
      color: white !important;
    }
    
    .header-username {
      color: white;
      font-weight: 600;
    }
    
    .header-logo {
      height: 40px;
      width: auto;
      margin-right: 15px;
      cursor: pointer;
      border-radius: 8px;
    }
    
    /* Notification styles */
    .notification-bell-container {
      position: relative;
      display: inline-block;
    }
    
    .notification-dot {
      position: absolute;
      top: -2px;
      right: -2px;
      width: 12px;
      height: 12px;
      background-color: #e74c3c;
      border-radius: 50%;
      border: 2px solid white;
      display: none;
      z-index: 10;
      animation: pulse 2s infinite;
    }
    
    .notification-dot.active {
      display: block;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
      70% { transform: scale(1.1); box-shadow: 0 0 0 6px rgba(231, 76, 60, 0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
    }
    
    .notification-item {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      border-left: 4px solid #c1dcba;
    }
    
    .notification-item.kastudy_accepted {
      border-left-color: #FFCF50;
    }
    
    .help-btn.yes-btn {
      background: linear-gradient(45deg, #c1dcba, #d4e8d1);
    }
    
    .help-btn.no-btn {
      background: #c0392b;
    }

    /* Weekly Recommendations Modal */
    #weekly-recommendations-modal .modal-content {
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
    }
  </style>
</head>
<body>
 <div class="dashboard-container">
    <aside class="sidebar">
      <!-- Active Users Icon -->
      <svg class="icon" onclick="window.location.href='/active-users.html'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
      <!-- Weekly Recommendations Icon (in sidebar) -->
      <svg class="icon" onclick="openWeeklyRecommendations()" title="Weekly Study Partner Recommendations" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
      <!-- Hamburger Menu Icon -->
      <svg class="icon" onclick="toggleMenu()" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
      <!-- Help/Question Icon -->
      <svg id="help-icon" class="icon" onclick="openHelpModal()" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>
      <!-- Grade Promotion Icon (only for special admin LRN) -->
      <svg id="grade-promotion-icon" class="icon" onclick="openGradePromotionModal()" title="Grade Promotion" style="display: none;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82zM12 3L1 9l11 6 9-4.91V17h2V9L12 3z"/></svg>
      <!-- Add User Icon (only for admins) -->
      <svg id="add-user-icon" class="icon" onclick="openAddUserModal()" title="Add New User" style="display: none;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
    </aside>

    <div id="menu-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close-btn" onclick="toggleMenu()">&times;</span>
            <h3><b>Password and Security</b></h3>
            <p>Gmail: <span id="menu-email"></span></p>
            <p>Password: ******** <button onclick="openChangePasswordModal()">Change</button></p>
            <hr>
            <button onclick="logout()">Log Out</button>
        </div>
    </div>

    <div id="change-password-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close-btn" onclick="closeChangePasswordModal()">&times;</span>
            <h3>Change Password</h3>
            <input type="password" id="current-password" placeholder="Current Password">
            <input type="password" id="new-password" placeholder="New Password">
            <input type="password" id="confirm-new-password" placeholder="Confirm New Password" oninput="validateNewPasswords()">
            <p id="password-validation-message" style="margin: 5px 0; font-size: 0.9em;"></p>
            <button onclick="changePassword()">Save Changes</button>
            <p id="change-password-message" style="color: red;"></p>
        </div>
    </div>

    <div class="main-content">
      <header class="dashboard-header">
        <div class="header-left" style="display: flex; align-items: center;">
          <img src="/images/logo.jpg" alt="StudyMatch Logo" class="header-logo" onclick="window.location.href='/homepage.html'">
        </div>
        <div class="header-icons">
          <div class="notification-bell-container" onclick="openNotificationsModal()">
            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg>
            <span id="notification-dot" class="notification-dot"></span>
          </div>
          <svg class="icon" onclick="window.location.href='/chats.html'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
        </div>


        <a href="/profile.html" class="header-profile">
          <div class="profile-initials" id="profile-initials"></div>
          <span id="user-name" class="header-username"></span>
        </a>
      </header>

      <main class="dashboard-main">
        <section class="todo-section">
          <div class="list-box" id="todo-list-container">
            <!-- To-do items will be dynamically inserted here -->
          </div>
          <button class="add-list-btn" onclick="openTodoModal()">+</button>
        </section>

        <!-- Profile Completion Reminder -->
        <div id="profile-reminder" class="profile-reminder" style="display: none;">
          <div class="reminder-content">
            <div class="reminder-icon">üìù</div>
            <div class="reminder-text">
              <strong>STUDYMATCH CSHSB:</strong> Finish setting up your profile by updating the subjects you are good at and need help with. You can see this through clicking your profile at the top right corner of your Homepage.
            </div>
          </div>
        </div>

        <!-- Add To-Do Modal -->
        <div id="todo-modal" class="modal" style="display:none;">
          <div class="modal-content">
            <span class="close-btn" onclick="closeTodoModal()">&times;</span>
            <h3>Add New To-Do</h3>
            <input type="text" id="todo-title" placeholder="Title (e.g., Quizzes)">
            <textarea id="todo-items" placeholder="Items (one per line)"></textarea>
            <button onclick="addTodo()">Add To-Do</button>
          </div>
        </div>
      </main>

      <!-- Find a KaStudy - Simplified -->
      <section class="find-kastudy-corner">
        <div class="find-content">
          <div class="speech-bubble">Find a KaStudy!</div>
          <div class="find-form">
            <select id="quick-grade" onchange="updateQuickSubject()">
              <option value="">Select Grade</option>
              <option value="7">Grade 7</option>
              <option value="8">Grade 8</option>
              <option value="9">Grade 9</option>
              <option value="10">Grade 10</option>
            </select>
            <select id="quick-subject">
              <option value="">Select Subject</option>
              <option value="ENGLISH">ENGLISH</option>
              <option value="FILIPINO">FILIPINO</option>
              <option value="SCIENCE">SCIENCE</option>
              <option value="MATH">MATH</option>
              <option value="ESP">ESP</option>
              <option value="AP">AP</option>
              <option value="ICT">ICT</option>
              <option value="MAPEH">MAPEH</option>
            </select>
            <button class="find-btn" onclick="quickFindKaStudy()">Find!</button>
          </div>
          <p id="quick-result" style="text-align: center; margin-top: 10px; font-size: 12px;"></p>
        </div>
      </section>


  <!-- Notifications Modal -->
  <div id="notifications-modal" class="modal" style="display:none;">
      <div class="modal-content">
          <span class="close-btn" onclick="closeNotificationsModal()">&times;</span>
          <h3><b>StudyMatch CSHSB</b></h3>
          <div id="notifications-list">
              <!-- Notifications will be loaded here -->
          </div>
          <div id="no-notifications" style="text-align: center; color: #666; padding: 20px;">
              <p>No notifications yet.</p>
          </div>
      </div>
  </div>

  <!-- Weekly Recommendations Modal -->
  <div id="weekly-recommendations-modal" class="modal" style="display:none;">
      <div class="modal-content">
          <span class="close-btn" onclick="closeWeeklyRecommendations()">&times;</span>
          <h3><b>üìÖ Weekly Study Partner Recommendations</b></h3>
          <p style="color: #666; margin-bottom: 20px;">Based on your profile and subjects, here are recommended study partners for you:</p>
          <div id="weekly-recommendations-list">
              <!-- Recommendations will be loaded here -->
          </div>
          <div id="no-recommendations" style="text-align: center; color: #666; padding: 20px; display: none;">
              <p>No recommendations available yet.</p>
              <p>Make sure you've completed your profile with strengths and weaknesses!</p>
          </div>
      </div>
  </div>

  <!-- Grade Promotion Modal (for special admin LRN 010101010101) -->
  <div id="grade-promotion-modal" class="modal" style="display:none;">
      <div class="modal-content" style="max-width: 800px; max-height: 85vh;">
          <span class="close-btn" onclick="closeGradePromotionModal()">&times;</span>
          <h3><b>üéì Grade Promotion Management</b></h3>
          <p style="color: #666; margin-bottom: 15px;">Select a promotion date and update student grades/sections:</p>
          
          <div style="margin-bottom: 20px;">
              <label for="promotion-date" style="font-weight: bold;">Promotion Date:</label>
              <input type="date" id="promotion-date" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; margin-left: 10px; width: 180px;">
          </div>
          
          <div id="grade-promotion-table-container" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px;">
              <table id="grade-promotion-table" style="width: 100%; border-collapse: collapse;">
                  <thead style="background: #f8f9fa; position: sticky; top: 0;">
                      <tr>
                          <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Name</th>
                          <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Surname</th>
                          <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Username</th>
                          <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">ID Number</th>
                          <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Grade</th>
                          <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Section</th>
                      </tr>
                  </thead>
                  <tbody id="students-list-body">
                      <!-- Students will be loaded here -->
                  </tbody>
              </table>
          </div>
          
          <div style="margin-top: 20px; text-align: right;">
              <button onclick="saveGradePromotions()" style="padding: 12px 24px; background: linear-gradient(135deg, #4CAF50, #388E3C); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 14px;">
                  üíæ Save Changes & Log Out Affected Users
              </button>
          </div>
          <p id="grade-promotion-message" style="margin-top: 10px; text-align: center;"></p>
      </div>
  </div>

  <!-- Add User Modal (for admins) -->
  <div id="add-user-modal" class="modal" style="display:none;">
      <div class="modal-content" style="max-width: 500px;">
          <span class="close-btn" onclick="closeAddUserModal()">&times;</span>
          <h3><b>‚úÖ Add New User</b></h3>
          <p style="color: #666; margin-bottom: 20px;">Add a new student to the allowed ID Number list:</p>
          
          <div style="margin-bottom: 15px;">
              <label for="new-user-lrn" style="font-weight: bold;">ID Number (12 digits):</label>
              <input type="text" id="new-user-lrn" placeholder="123456789012" maxlength="12" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-top: 5px;">
          </div>
          
          <div style="margin-bottom: 15px;">
              <label for="new-user-name" style="font-weight: bold;">First Name:</label>
              <input type="text" id="new-user-name" placeholder="Juan" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-top: 5px;">
          </div>
          
          <div style="margin-bottom: 15px;">
              <label for="new-user-surname" style="font-weight: bold;">Surname:</label>
              <input type="text" id="new-user-surname" placeholder="Dela Cruz" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-top: 5px;">
          </div>
          
          <div style="margin-bottom: 15px;">
              <label for="new-user-grade" style="font-weight: bold;">Grade:</label>
              <select id="new-user-grade" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-top: 5px;">
                  <option value="">Select Grade</option>
                  <option value="7">Grade 7</option>
                  <option value="8">Grade 8</option>
                  <option value="9">Grade 9</option>
                  <option value="10">Grade 10</option>
              </select>
          </div>
          
          <div style="margin-bottom: 15px;">
              <label for="new-user-section" style="font-weight: bold;">Section:</label>
              <select id="new-user-section" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-top: 5px;">
                  <option value="">Select Section</option>
                  <option value="Android">Android</option>
                  <option value="Oracle">Oracle</option>
                  <option value="Symbian">Symbian</option>
                  <option value="Macintosh">Macintosh</option>
                  <option value="Redhat">Redhat</option>
                  <option value="Unix">Unix</option>
                  <option value="Fedora">Fedora</option>
                  <option value="Minix">Minix</option>
                  <option value="Solaris">Solaris</option>
                  <option value="Chimera">Chimera</option>
                  <option value="Linux">Linux</option>
                  <option value="Xenix">Xenix</option>
              </select>
          </div>
          
          <div style="margin-bottom: 15px;">
              <label style="font-weight: bold; display: block;">
                  <input type="checkbox" id="new-user-is-admin" style="margin-right: 10px;">
                  Is Admin (Teacher)
              </label>
          </div>
          
          <div id="teaching-subject-field" style="margin-bottom: 15px; display: none;">
              <label for="new-user-teaching-subject" style="font-weight: bold;">Teaching Subject:</label>
              <select id="new-user-teaching-subject" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-top: 5px;">
                  <option value="">Select Subject</option>
                  <option value="Filipino">Filipino</option>
                  <option value="English">English</option>
                  <option value="Science">Science</option>
                  <option value="Math">Math</option>
                  <option value="ICT">ICT</option>
                  <option value="ESP">ESP</option>
                  <option value="AP">AP</option>
                  <option value="MAPEH">MAPEH</option>
              </select>
          </div>
          
          <button onclick="addNewUser()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #4CAF50, #388E3C); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px;">
              ‚úÖ Add User
          </button>
          <p id="add-user-message" style="margin-top: 10px; text-align: center;"></p>
          
          <!-- List of Added Users -->
          <div style="margin-top: 25px; border-top: 2px solid #ddd; padding-top: 15px;">
              <h4 style="margin: 0 0 10px 0; color: #347433;">List of Added Users</h4>
              <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px;">
                  <table id="added-users-table" style="width: 100%; border-collapse: collapse; font-size: 12px;">
                      <thead style="background: #f8f9fa; position: sticky; top: 0;">
                          <tr>
                              <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">ID Number</th>
                              <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">Name</th>
                              <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">Type</th>
                          </tr>
                      </thead>
                      <tbody id="added-users-tbody">
                          <tr><td colspan="3" style="padding: 10px; text-align: center; color: #666;">Loading...</td></tr>
                      </tbody>
                  </table>
              </div>
          </div>
      </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
  const backendURL = window.location.origin;
  const socket = io();
  
  // Track unread notifications count
  let unreadCount = 0;
  let currentUserIsAdmin = false;

  // Check if user is logged in on page load
  async function checkAuthentication() {
    try {
      const response = await fetch(`${backendURL}/check-session`, {
        method: 'GET',
        credentials: 'include'
      });

      if (!response.ok) {
        // Not authenticated, redirect to login
        window.location.href = '/index.html';
        return;
      }

      const data = await response.json();
      if (!data.loggedIn) {
        // Not authenticated, redirect to login
        window.location.href = '/index.html';
        return;
      }

      // Check if profile is complete
      if (!data.profileComplete) {
        // Profile not complete, redirect to profile setup
        window.location.href = '/profile-setup.html';
        return;
      }

      // User is authenticated and profile is complete, continue with page load
      console.log('User authenticated:', data.email);
    } catch (error) {
      console.log('Authentication check failed:', error);
      // On error, redirect to login to be safe
      window.location.href = '/index.html';
    }
  }

    function openTodoModal() {
      document.getElementById('todo-modal').style.display = 'block';
    }

    function closeTodoModal() {
      document.getElementById('todo-modal').style.display = 'none';
    }

    function openHelpModal() {
      document.getElementById('help-modal').style.display = 'block';
    }

    function closeHelpModal() {
      document.getElementById('help-modal').style.display = 'none';
    }

    async function toggleMenu() {
        const menu = document.getElementById('menu-modal');
        if (menu.style.display === 'block') {
            menu.style.display = 'none';
        } else {
            try {
              const response = await fetch(`${backendURL}/get-profile`, {
                credentials: 'include'
              });
              if (!response.ok) {
                throw new Error('Failed to fetch profile');
              }
              const data = await response.json();
              if (data.success) {
                document.getElementById('menu-email').innerText = data.user.email;
              }
            } catch (error) {
              console.error("Error fetching profile:", error);
            }
            menu.style.display = 'block';
        }
    }

    function openChangePasswordModal() {
        document.getElementById('change-password-modal').style.display = 'block';
    }

    function closeChangePasswordModal() {
        document.getElementById('change-password-modal').style.display = 'none';
    }

    async function fetchTodos() {
      console.log('fetchTodos() called');
      try {
        const response = await fetch(`${backendURL}/get-todos`, {
          credentials: 'include'
        });
        console.log('Fetch todos response status:', response.status);
        if (!response.ok) {
          throw new Error('Failed to fetch to-dos.');
        }
        const todos = await response.json();
        console.log('Fetched todos:', todos);
        const container = document.getElementById('todo-list-container');
        container.innerHTML = ''; // Clear existing todos
        todos.forEach(todo => {
          const todoEl = document.createElement('div');
          todoEl.className = 'todo-item';
          todoEl.innerHTML = `
            <h3>
              ${todo.title}
              <span class="delete-btn" onclick="deleteTodo('${todo._id}')">&times;</span>
            </h3>
            <p>${Array.isArray(todo.items) ? todo.items.join('<br>') : ''}</p>
          `;
          container.appendChild(todoEl);
        });
      } catch (error) {
        console.error("Error fetching todos:", error);
        // Optionally show an error to the user
      }
    }

    async function addTodo() {
      const title = document.getElementById('todo-title').value;
      const items = document.getElementById('todo-items').value.split('\n').filter(item => item.trim() !== '');

      if (!title || items.length === 0) {
        alert("Please provide a title and at least one item.");
        return;
      }

      try {
        const response = await fetch(`${backendURL}/add-todo`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ title, items })
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Failed to add to-do');
        }

        closeTodoModal();
        fetchTodos(); // Refresh the list
      } catch (error) {
        console.error("Error adding todo:", error);
        alert(`Error: ${error.message}`);
      }
    }
  
    async function deleteTodo(id) {
      if (!confirm("Are you sure you want to delete this to-do list?")) {
        return;
      }
  
      try {
        const response = await fetch(`${backendURL}/delete-todo/${id}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Failed to delete to-do');
        }
        fetchTodos(); // Refresh the list
      } catch (error) {
        console.error("Error deleting todo:", error);
        alert(`Error: ${error.message}`);
      }
    }
  
    async function submitHelpRequest() {
      const message = document.getElementById('help-request').value;
      if (!message.trim()) {
        alert('Please enter your query or suggestion.');
        return;
      }
  
      try {
        const response = await fetch(`${backendURL}/send-help-request`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });
  
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Failed to send help request.');
        }
  
        document.getElementById('help-request').value = '';
        const helpMessageEl = document.getElementById('help-message');
        helpMessageEl.innerText = "Thank you for letting us know. We'll get back to you with an update. Kindly check your email address for our response.";
        setTimeout(() => {
          closeHelpModal();
          helpMessageEl.innerText = '';
        }, 5000);
  
      } catch (error) {
        console.error("Error sending help request:", error);
        alert(`Error: ${error.message}`);
      }
    }

    function validateNewPasswords() {
        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-new-password').value;
        const messageEl = document.getElementById('password-validation-message');
        const confirmInput = document.getElementById('confirm-new-password');

        if (confirmPassword === '') {
            messageEl.innerText = '';
            confirmInput.style.borderColor = '';
            return;
        }

        if (newPassword === confirmPassword) {
            messageEl.innerText = '‚úì Passwords match!';
            messageEl.style.color = 'green';
            confirmInput.style.borderColor = 'green';
        } else {
            messageEl.innerText = '‚úó Passwords do not match';
            messageEl.style.color = 'red';
            confirmInput.style.borderColor = 'red';
        }
    }

    async function changePassword() {
        const currentPassword = document.getElementById('current-password').value;
        const newPassword = document.getElementById('new-password').value;
        const confirmNewPassword = document.getElementById('confirm-new-password').value;
        const messageEl = document.getElementById('change-password-message');

        if (newPassword !== confirmNewPassword) {
            messageEl.innerText = "New passwords do not match.";
            return;
        }

        try {
            const response = await fetch(`${backendURL}/change-password`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ currentPassword, newPassword })
            });

            const data = await response.json();

            if (data.success) {
                messageEl.style.color = 'green';
                messageEl.innerText = "Password changed successfully!";
                setTimeout(() => {
                    closeChangePasswordModal();
                    messageEl.innerText = '';
                    messageEl.style.color = 'red';
                }, 2000);
            } else {
                messageEl.innerText = data.message;
            }
        } catch (error) {
            console.error("Error changing password:", error);
            messageEl.innerText = "An error occurred. Please try again.";
        }
    }

    async function logout() {
        if (confirm("Save password for future log-ins?")) {
            console.log("User chose to save password.");
            // Password is already saved in localStorage from login
        } else {
            console.log("User chose not to save password.");
            localStorage.removeItem('savedEmail');
            localStorage.removeItem('savedPassword');
        }

        try {
            await fetch(`${backendURL}/logout`, { method: 'POST' });
            window.location.href = '/index.html';
        } catch (error) {
            console.error("Error logging out:", error);
        }
    }

    // Simplified Find KaStudy function
    async function quickFindKaStudy() {
        const grade = document.getElementById('quick-grade').value;
        const subject = document.getElementById('quick-subject').value;
        const resultEl = document.getElementById('quick-result');
        
        // Client-side profanity check
        const inappropriateWords = ['fuck', 'fuk', 'fck', 'fucku', 'fcku', 'fuk u', 'fuck you', 'fuckyou', 'shit', 'shyt', 'sh1t', 'shitty', 'ass', 'azz', 'as5', 'a55', 'butt', 'bitch', 'b1tch', 'bich', 'bitxh', 'btch', 'bastard', 'bastrd', 'baster', 'damn', 'damnit', 'dammit', 'hell', 'hellno', 'hell no', 'crap', 'crappy', 'dick', 'd1ck', 'dik', 'piss', 'p1ss', 'cock', 'c0ck', 'cok', 'cunt', 'c0nt', 'whore', 'whor3', 'slut', 'sl1ut', '5lut', 'gay', 'g4y', 'faggot', 'fagg0t', 'fagot', 'retard', 'ret1rd', 'retarded', 'idiot', '1d1ot', 'stupid', 'st00pid', 'ugly', 'ug1y', 'hate', 'hat3', 'loser', 'l0ser', 'dumb', 'dumbass', 'porn', 'p0rn', 'pr0n', 'xxx', 'sex', 's3x', 'nude', 'n00d', 'nipple', 'nipples', 'vagina', 'vajina', 'pussy', 'pusssy', 'penis', 'p3nis', 'boob', 'boobs', 'tits', 'tit'];
        
        function containsInappropriateWords(text) {
          if (!text) return false;
          const lowerText = text.toLowerCase();
          return inappropriateWords.some(word => lowerText.includes(word));
        }
        
        console.log('quickFindKaStudy called - grade:', grade, 'subject:', subject);
        
        // Check for inappropriate words
        if (containsInappropriateWords(subject)) {
            resultEl.innerText = 'Please use appropriate language for the subject.';
            resultEl.style.color = 'red';
            return;
        }
        
        if (!grade) {
            resultEl.innerText = 'Please select a grade level.';
            resultEl.style.color = 'red';
            return;
        }
        
        if (!subject) {
            resultEl.innerText = 'Please select a subject.';
            resultEl.style.color = 'red';
            return;
        }
        
        resultEl.innerText = 'Sending...';
        resultEl.style.color = 'blue';
        
        try {
            const response = await fetch(`${backendURL}/find-kastudy`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    grade: parseInt(grade),
                    subject: subject
                }),
                credentials: 'include'
            });

            const data = await response.json();
            
            if (response.ok) {
                resultEl.innerText = data.message;
                resultEl.style.color = 'green';
                alert(data.message);
            } else {
                resultEl.innerText = 'Error: ' + data.message;
                resultEl.style.color = 'red';
                alert('Error: ' + data.message);
            }
        } catch (error) {
            console.error('Error:', error);
            resultEl.innerText = 'Network error: ' + error.message;
            resultEl.style.color = 'red';
        }
    }

    // Old modal-based functions (kept for reference but not used)
    let selectedGrade = null;
    let selectedSubject = null;

    function openGradeModal() {
        document.getElementById('grade-modal').style.display = 'block';
    }

    function closeGradeModal() {
        document.getElementById('grade-modal').style.display = 'none';
    }

    function selectGrade(grade) {
        selectedGrade = grade;
        document.getElementById('selected-grade').value = grade;
        document.getElementById('grade-display').innerText = 'Selected: Grade ' + grade;
        closeGradeModal();
        openSubjectModal();
    }

    function openSubjectModal() {
        document.getElementById('subject-modal').style.display = 'block';
    }

    function closeSubjectModal() {
        document.getElementById('subject-modal').style.display = 'none';
    }

    function selectSubject(subject) {
        selectedSubject = subject;
        document.getElementById('selected-subject').value = subject;
        document.getElementById('subject-display').innerText = 'Selected Subject: ' + subject;
        closeSubjectModal();
        openConfirmationModal();
    }

    function openConfirmationModal() {
        document.getElementById('confirmation-modal').style.display = 'block';
        const grade = document.getElementById('selected-grade').value;
        const subject = document.getElementById('selected-subject').value;
        document.getElementById('confirmation-display').innerText = 'Grade ' + grade + ' - ' + subject;
    }

    function closeConfirmationModal() {
        document.getElementById('confirmation-modal').style.display = 'none';
    }

    async function confirmFind(yes) {
        if (yes) {
            const grade = document.getElementById('selected-grade').value;
            const subject = document.getElementById('selected-subject').value;
            
            if (!grade || !subject) {
                alert('Please select both grade level and subject.');
                return;
            }
            
            closeConfirmationModal();
            
            try {
                const response = await fetch(`${backendURL}/find-kastudy`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        grade: parseInt(grade),
                        subject: subject
                    }),
                    credentials: 'include'
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to send help request');
                }

                const data = await response.json();
                alert(data.message || 'Help request sent successfully!');
                selectedGrade = null;
                selectedSubject = null;
            } catch (error) {
                console.error('Error sending help request:', error);
                alert('Error sending help request. Please try again. Error: ' + error.message);
            }
        } else {
            closeConfirmationModal();
            closeGradeModal();
            closeSubjectModal();
            selectedGrade = null;
            selectedSubject = null;
        }
    }

    function openSearchingModal() {
        document.getElementById('searching-modal').style.display = 'block';
    }


    function openNotificationsModal() {
        document.getElementById('notifications-modal').style.display = 'block';
        loadNotifications();
    }

    function closeNotificationsModal() {
        document.getElementById('notifications-modal').style.display = 'none';
    }

    // Weekly Recommendations functions
    function openWeeklyRecommendations() {
        document.getElementById('weekly-recommendations-modal').style.display = 'block';
        loadWeeklyRecommendations();
    }

    function closeWeeklyRecommendations() {
        document.getElementById('weekly-recommendations-modal').style.display = 'none';
    }

    // Grade Promotion functions
    function openGradePromotionModal() {
        document.getElementById('grade-promotion-modal').style.display = 'block';
        loadStudentsForPromotion();
        
        // Set default date to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('promotion-date').value = today;
    }

    function closeGradePromotionModal() {
        document.getElementById('grade-promotion-modal').style.display = 'none';
    }

    // Add User functions
    function openAddUserModal() {
        document.getElementById('add-user-modal').style.display = 'block';
        // Clear previous values
        document.getElementById('new-user-lrn').value = '';
        document.getElementById('new-user-name').value = '';
        document.getElementById('new-user-surname').value = '';
        document.getElementById('new-user-grade').value = '';
        document.getElementById('new-user-section').value = '';
        document.getElementById('new-user-is-admin').checked = false;
        document.getElementById('new-user-teaching-subject').value = '';
        document.getElementById('teaching-subject-field').style.display = 'none';
        document.getElementById('add-user-message').innerText = '';
        
        // Load the list of added users
        loadAddedUsers();
    }
    
    // Load the list of added users
    async function loadAddedUsers() {
        const tbody = document.getElementById('added-users-tbody');
        tbody.innerHTML = '<tr><td colspan="3" style="padding: 10px; text-align: center; color: #666;">Loading...</td></tr>';
        
        try {
            const response = await fetch(`${backendURL}/admin/get-allowed-users`, {
                credentials: 'include'
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.users.length > 0) {
                    let html = '';
                    data.users.forEach(user => {
                        html += `<tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 8px;">${user.lrn}</td>
                            <td style="padding: 8px;">${user.firstName} ${user.surname}</td>
                            <td style="padding: 8px;">${user.isAdmin ? '<span style="color: #e74c3c; font-weight: bold;">Admin</span>' : '<span style="color: #347433;">Student</span>'}</td>
                        </tr>`;
                    });
                    tbody.innerHTML = html;
                } else {
                    tbody.innerHTML = '<tr><td colspan="3" style="padding: 10px; text-align: center; color: #666;">No users added yet</td></tr>';
                }
            } else {
                tbody.innerHTML = '<tr><td colspan="3" style="padding: 10px; text-align: center; color: red;">Failed to load users</td></tr>';
            }
        } catch (error) {
            console.error('Error loading users:', error);
            tbody.innerHTML = '<tr><td colspan="3" style="padding: 10px; text-align: center; color: red;">Error loading users</td></tr>';
        }
    }
    
    // Show/hide teaching subject field based on admin checkbox
    document.getElementById('new-user-is-admin')?.addEventListener('change', function() {
        const teachingField = document.getElementById('teaching-subject-field');
        if (this.checked) {
            teachingField.style.display = 'block';
            document.getElementById('new-user-grade').closest('div').style.display = 'none';
            document.getElementById('new-user-section').closest('div').style.display = 'none';
        } else {
            teachingField.style.display = 'none';
            document.getElementById('new-user-grade').closest('div').style.display = 'block';
            document.getElementById('new-user-section').closest('div').style.display = 'block';
        }
    });

    function closeAddUserModal() {
        document.getElementById('add-user-modal').style.display = 'none';
    }

    async function addNewUser() {
        const lrn = document.getElementById('new-user-lrn').value.trim();
        const name = document.getElementById('new-user-name').value.trim();
        const surname = document.getElementById('new-user-surname').value.trim();
        const grade = document.getElementById('new-user-grade').value;
        const section = document.getElementById('new-user-section').value.trim();
        const isAdmin = document.getElementById('new-user-is-admin')?.checked || false;
        const teachingSubject = document.getElementById('new-user-teaching-subject')?.value || null;
        const messageEl = document.getElementById('add-user-message');
        
        // Validation
        if (!lrn || lrn.length !== 12) {
            messageEl.innerText = 'Please enter a valid 12-digit ID Number.';
            messageEl.style.color = 'red';
            return;
        }
        
        if (!name) {
            messageEl.innerText = 'Please enter the first name.';
            messageEl.style.color = 'red';
            return;
        }
        
        if (!surname) {
            messageEl.innerText = 'Please enter the surname.';
            messageEl.style.color = 'red';
            return;
        }
        
        if (isAdmin) {
            if (!teachingSubject) {
                messageEl.innerText = 'Please select a teaching subject for admin.';
                messageEl.style.color = 'red';
                return;
            }
        } else {
            if (!grade) {
                messageEl.innerText = 'Please select a grade.';
                messageEl.style.color = 'red';
                return;
            }
            
            if (!section) {
                messageEl.innerText = 'Please select a section.';
                messageEl.style.color = 'red';
                return;
            }
        }
        
        messageEl.innerText = 'Adding user...';
        messageEl.style.color = 'blue';
        
        try {
            const response = await fetch(`${backendURL}/admin/add-lrn-user`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                    lrn: lrn,
                    firstName: name,
                    surname: surname,
                    grade: grade,
                    section: section,
                    isAdmin: isAdmin,
                    teachingSubject: teachingSubject
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                messageEl.innerText = 'User added successfully!';
                messageEl.style.color = 'green';
                // Reload the user list to reflect the new user
                loadAddedUsers();
                setTimeout(() => {
                    closeAddUserModal();
                }, 1500);
            } else {
                messageEl.innerText = data.message || 'Failed to add user.';
                messageEl.style.color = 'red';
            }
        } catch (error) {
            console.error('Error adding user:', error);
            messageEl.innerText = 'An error occurred. Please try again.';
            messageEl.style.color = 'red';
        }
    }

    async function loadStudentsForPromotion() {
        try {
            const response = await fetch(`${backendURL}/admin/get-all-students-for-promotion`, {
                credentials: 'include'
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to fetch students');
            }
            
            const data = await response.json();
            
            if (data.success) {
                displayStudentsForPromotion(data.students);
            } else {
                document.getElementById('students-list-body').innerHTML = 
                    '<tr><td colspan="6" style="text-align: center; padding: 20px; color: red;">' + data.message + '</td></tr>';
            }
        } catch (error) {
            console.error("Error loading students:", error);
            document.getElementById('students-list-body').innerHTML = 
                '<tr><td colspan="6" style="text-align: center; padding: 20px; color: red;">Failed to load students. ' + error.message + '</td></tr>';
        }
    }

    function displayStudentsForPromotion(students) {
        const tbody = document.getElementById('students-list-body');
        
        if (!students || students.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #666;">No students found.</td></tr>';
            return;
        }
        
        let html = '';
        students.forEach((student, index) => {
            html += `
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 10px;">${student.name || ''}</td>
                    <td style="padding: 10px;">${student.surname || ''}</td>
                    <td style="padding: 10px;">${student.username || ''}</td>
                    <td style="padding: 10px;">${student.lrn || ''}</td>
                    <td style="padding: 10px;">
                        <input type="text" 
                               id="grade-${index}" 
                               value="${student.grade || ''}" 
                               style="width: 60px; padding: 5px; border: 1px solid #ddd; border-radius: 4px;"
                               data-email="${student.email}">
                    </td>
                    <td style="padding: 10px;">
                        <input type="text" 
                               id="section-${index}" 
                               value="${student.section || ''}" 
                               style="width: 80px; padding: 5px; border: 1px solid #ddd; border-radius: 4px;"
                               data-email="${student.email}">
                    </td>
                </tr>
            `;
        });
        
        tbody.innerHTML = html;
    }

    async function saveGradePromotions() {
        const messageEl = document.getElementById('grade-promotion-message');
        const promotionDate = document.getElementById('promotion-date').value;
        
        if (!promotionDate) {
            messageEl.innerText = 'Please select a promotion date.';
            messageEl.style.color = 'red';
            return;
        }
        
        // Gather all updated grades and sections
        const updates = [];
        const rows = document.querySelectorAll('#students-list-body tr');
        
        rows.forEach((row, index) => {
            const gradeInput = document.getElementById(`grade-${index}`);
            const sectionInput = document.getElementById(`section-${index}`);
            
            if (gradeInput) {
                updates.push({
                    email: gradeInput.dataset.email,
                    newGrade: gradeInput.value,
                    newSection: sectionInput.value
                });
            }
        });
        
        if (updates.length === 0) {
            messageEl.innerText = 'No students to update.';
            messageEl.style.color = 'orange';
            return;
        }
        
        messageEl.innerText = 'Saving changes...';
        messageEl.style.color = 'blue';
        
        let successCount = 0;
        let affectedEmails = [];
        
        // Update each student one by one
        for (const update of updates) {
            try {
                const response = await fetch(`${backendURL}/admin/update-student-grade`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        email: update.email,
                        newGrade: update.newGrade,
                        newSection: update.newSection
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    successCount++;
                    affectedEmails.push(update.email);
                } else {
                    console.error('Failed to update:', update.email, data.message);
                }
            } catch (error) {
                console.error('Error updating student:', update.email, error);
            }
        }
        
        if (successCount > 0) {
            messageEl.innerText = `Successfully updated ${successCount} student(s). Affected users will be logged out.`;
            messageEl.style.color = 'green';
            
            // Log out affected users by redirecting to login after a delay
            setTimeout(() => {
                alert(`Grade promotion completed! ${successCount} student(s) have been updated. They will need to log in again.`);
                closeGradePromotionModal();
            }, 1000);
        } else {
            messageEl.innerText = 'Failed to update any students.';
            messageEl.style.color = 'red';
        }
    }

    async function loadWeeklyRecommendations() {
        try {
            const response = await fetch(`${backendURL}/get-weekly-recommendations`);
            if (!response.ok) throw new Error('Failed to fetch recommendations');
            
            const data = await response.json();
            
            if (data.success) {
                displayWeeklyRecommendations(data);
            }
        } catch (error) {
            console.error("Error loading recommendations:", error);
            document.getElementById('weekly-recommendations-list').innerHTML = 
                '<div style="text-align: center; color: #666; padding: 20px;">Failed to load recommendations.</div>';
        }
    }

    function displayWeeklyRecommendations(data) {
        const container = document.getElementById('weekly-recommendations-list');
        const noRec = document.getElementById('no-recommendations');

        if (!data.recommendations || data.recommendations.length === 0) {
            container.innerHTML = '';
            noRec.style.display = 'block';
            noRec.innerHTML = `<p>${data.message || 'No recommendations available yet.'}</p>`;
            return;
        }

        noRec.style.display = 'none';
        let html = `<p style="color: #1B5E20; font-weight: bold; margin-bottom: 15px;">You've been with StudyMatch for ${data.weeksActive} week(s)! Here are your matched study partners:</p>`;
        
        data.recommendations.forEach((rec, index) => {
            const matchReasons = [];
            if (rec.canHelpYou > 0) {
                matchReasons.push(`Can help you with: ${rec.strengths.filter(s => (data.userWeaknesses || []).includes(s)).slice(0, 3).join(', ')}`);
            }
            if (rec.youCanHelp > 0) {
                matchReasons.push(`You can help with: ${rec.weaknesses.filter(w => (data.userStrengths || []).includes(w)).slice(0, 3).join(', ')}`);
            }
            
            html += `
                <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin-bottom: 15px; border-left: 4px solid #347433;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>
                            <strong style="font-size: 16px; color: #1B5E20;">${rec.name} ${rec.surname}</strong>
                            <span style="color: #666; margin-left: 10px;">@${rec.username}</span>
                        </div>
                        <span style="background: #c1dcba; color: #347433; padding: 5px 12px; border-radius: 15px; font-size: 12px; font-weight: bold;">Match Score: ${rec.score}</span>
                    </div>
                    <div style="font-size: 13px; color: #666;">
                        <div><strong>Their Strengths:</strong> ${rec.strengths.join(', ') || 'Not set'}</div>
                        <div><strong>Needs Help With:</strong> ${rec.weaknesses.join(', ') || 'Not set'}</div>
                    </div>
                    <button onclick="requestAsStudyPartner('${rec.email}', '${rec.username}')" style="margin-top: 10px; width: 100%; padding: 10px; background: linear-gradient(135deg, #4CAF50, #388E3C); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                        ü§ù Request as Study Partner
                    </button>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    async function requestAsStudyPartner(email, username) {
        if (!confirm(`Request ${username} as your study partner?`)) return;
        
        try {
            const response = await fetch(`${backendURL}/find-kastudy`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    grade: parseInt(document.getElementById('quick-grade')?.value || 7),
                    subject: 'STUDY_PARTNER'
                }),
                credentials: 'include'
            });

            const data = await response.json();
            alert(data.message || 'Study partner request sent!');
        } catch (error) {
            console.error('Error requesting study partner:', error);
            alert('Failed to send request. Please try again.');
        }
    }

    // Update the notification dot visibility
    function updateNotificationDot(count) {
        const dot = document.getElementById('notification-dot');
        if (count > 0) {
            dot.classList.add('active');
        } else {
            dot.classList.remove('active');
        }
    }

    // Load notifications
    async function loadNotifications() {
        try {
            const response = await fetch(`${backendURL}/get-notifications`, {
                credentials: 'include'
            });
            if (!response.ok) {
                throw new Error('Failed to fetch notifications');
            }
            const data = await response.json();
            const notifications = data.notifications || [];
            
            // Update notification count and dot
            unreadCount = notifications.length;
            updateNotificationDot(unreadCount);
            
            displayNotifications(notifications);
        } catch (error) {
            console.error("Error loading notifications:", error);
        }
    }

    // Display notifications in the modal
    function displayNotifications(notifications) {
        const container = document.getElementById('notifications-list');
        const noNotifications = document.getElementById('no-notifications');

        // Make sure notifications list is visible
        container.style.display = 'block';
        
        if (notifications.length === 0) {
            container.innerHTML = '';
            noNotifications.style.display = 'block';
            return;
        }

        noNotifications.style.display = 'none';
        container.innerHTML = '';

        notifications.forEach(notification => {
            if (notification.type === 'help_request') {
                const notificationDiv = document.createElement('div');
                notificationDiv.className = 'notification-item';
                notificationDiv.innerHTML = `
                    <div class="notification-content">
                        <strong>STUDYMATCH CSHSB</strong><br>
                        ${notification.message}
                    </div>
                    <div class="notification-actions">
                        <button class="help-btn yes-btn" onclick="respondToHelpRequest('${notification.id}', 'accept', '${notification.fromUser.email}', '${notification.subject}')">Yes</button>
                        <button class="help-btn no-btn" onclick="respondToHelpRequest('${notification.id}', 'decline')">No</button>
                    </div>
                `;
                container.appendChild(notificationDiv);
            } else if (notification.type === 'kastudy_request') {
                const notificationDiv = document.createElement('div');
                notificationDiv.className = 'notification-item';
                notificationDiv.innerHTML = `
                    <div class="notification-content">
                        <strong>STUDYMATCH CSHSB</strong><br>
                        ${notification.message}
                    </div>
                    <div class="notification-actions">
                        <button class="help-btn yes-btn" onclick="respondToKastudyRequest('${notification.id}', 'accept', '${notification.fromUser.email}', '${notification.subject}', '${notification.fromUser.username || ''}')">Yes</button>
                        <button class="help-btn no-btn" onclick="respondToKastudyRequest('${notification.id}', 'decline')">No</button>
                    </div>
                `;
                container.appendChild(notificationDiv);
            } else if (notification.type === 'kastudy_accepted') {
                const notificationDiv = document.createElement('div');
                notificationDiv.className = 'notification-item kastudy_accepted';
                const chatUrl = notification.redirectUrl || '/chats.html?chat=' + encodeURIComponent(notification.fromUser.email);
                notificationDiv.innerHTML = `
                    <div class="notification-content">
                        <strong>STUDYMATCH CSHSB</strong><br>
                        ${notification.message}
                    </div>
                    <div class="notification-actions">
                        <button class="help-btn yes-btn" onclick="window.location.href='${chatUrl}'" style="width: 100%; background: #3498db; color: white;">Start Chatting</button>
                    </div>
                `;
                container.appendChild(notificationDiv);
            }
        });
    }

    // Handle help request response
    async function respondToHelpRequest(notificationId, response, requesterEmail, subject, requesterName) {
        // Immediately remove the notification element from the UI
        const notificationElements = document.querySelectorAll('.notification-item');
        notificationElements.forEach(el => {
            if (el.innerHTML.includes(notificationId)) {
                el.remove();
            }
        });
        
        // Also check and update no-notifications div
        const remainingNotifications = document.querySelectorAll('.notification-item');
        if (remainingNotifications.length === 0) {
            document.getElementById('no-notifications').style.display = 'block';
            document.getElementById('notifications-list').style.display = 'none';
        }
        
        // Update notification dot
        unreadCount = Math.max(0, unreadCount - 1);
        updateNotificationDot(unreadCount);
        
        try {
            const responseData = await fetch(`${backendURL}/respond-help-request`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    notificationId,
                    response,
                    requesterEmail,
                    subject,
                    requesterName
                })
            });

            if (!responseData.ok) {
                throw new Error('Failed to respond to help request');
            }

            const data = await responseData.json();

            if (response === 'accept') {
                alert(data.message);
                // Redirect to chats page with the requester's email
                window.location.href = data.redirectUrl || '/chats.html?chat=' + encodeURIComponent(requesterEmail);
            } else {
                // Reload to ensure the notification is removed
                loadNotifications();
            }
        } catch (error) {
            console.error("Error responding to help request:", error);
            alert('Error processing your response. Please try again.');
        }
    }


    // Handle kastudy request response
    async function respondToKastudyRequest(notificationId, response, requesterEmail, subject, requesterName) {
        // Immediately remove the notification element from the UI
        const notificationElements = document.querySelectorAll('.notification-item');
        notificationElements.forEach(el => {
            if (el.innerHTML.includes(notificationId)) {
                el.remove();
            }
        });
        
        // Also check and update no-notifications div
        const remainingNotifications = document.querySelectorAll('.notification-item');
        if (remainingNotifications.length === 0) {
            document.getElementById('no-notifications').style.display = 'block';
            document.getElementById('notifications-list').style.display = 'none';
        }
        
        // Update notification dot
        unreadCount = Math.max(0, unreadCount - 1);
        updateNotificationDot(unreadCount);
        
        try {
            const responseData = await fetch(`${backendURL}/respond-kastudy-request`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    notificationId,
                    response,
                    requesterEmail,
                    subject,
                    requesterName
                })
            });

            if (!responseData.ok) {
                throw new Error('Failed to respond to kastudy request');
            }

            const data = await responseData.json();

            if (response === 'accept') {
                alert(data.message);
                // Redirect to chats page with the requester's email
                window.location.href = data.redirectUrl || '/chats.html?chat=' + encodeURIComponent(requesterEmail);
            } else {
                // Reload to ensure the notification is removed
                loadNotifications();
            }
        } catch (error) {
            console.error("Error responding to kastudy request:", error);
            alert('Error processing your response. Please try again.');
        }
    }


    // Fetch user profile and set initials
    async function fetchUserProfile() {
      try {
        const response = await fetch(`${backendURL}/get-profile`, {
        credentials: 'include'
      });
        if (!response.ok) {
          throw new Error('Failed to fetch profile');
        }
        const data = await response.json();
        if (data.success) {
          console.log('User profile loaded:', data.user);
          // Set username beside profile circle
          document.getElementById('user-name').innerText = data.user.username;

          // Set profile initials
          const initials = data.user.username.charAt(0).toUpperCase();
          document.getElementById('profile-initials').innerText = initials;
          
          // Check if user is admin and hide help icon
          currentUserIsAdmin = data.user.isAdmin || false;
          if (currentUserIsAdmin) {
            document.getElementById('help-icon').style.display = 'none';
            // Also hide the Find a KaStudy section for admins
            const findKaStudySection = document.querySelector('.find-kastudy-corner');
            if (findKaStudySection) {
              findKaStudySection.style.display = 'none';
            }
            
            // Show add user icon for all admins
            document.getElementById('add-user-icon').style.display = 'block';
            
            // Show grade promotion icon only for special admin LRN
            if (data.user.lrn === '010101010101') {
              document.getElementById('grade-promotion-icon').style.display = 'block';
            }
          }

          // Join socket room for real-time notifications
          joinSocketRoom(data.user.email);

          // Check profile completion status
          checkProfileCompletion(data.user);
          
          // Load notifications and show dot if there are any
          loadNotifications();
        }
      } catch (error) {
        console.error("Error fetching profile:", error);
      }
    }

    // Check if user has completed their profile (has strengths and weaknesses)
    function checkProfileCompletion(user) {
      const reminder = document.getElementById('profile-reminder');

      // Show reminder if user doesn't have strengths or weaknesses set
      if (!user.strengths || user.strengths.length === 0 || !user.weaknesses || user.weaknesses.length === 0) {
        reminder.style.display = 'block';
      } else {
        reminder.style.display = 'none';
      }
    }

    // Fetch todos and user profile when the page loads
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('DOMContentLoaded - starting auth check');
      try {
        await checkAuthentication();
        console.log('Auth check passed, fetching todos and profile');
        fetchTodos();
        fetchUserProfile();
        // Start polling for notifications as backup
        startNotificationPolling();
      } catch (error) {
        console.error('Error in DOMContentLoaded:', error);
      }
    });

    // Socket.io event listeners for real-time notifications
    socket.on('new_notification', (notification) => {
      console.log('New notification received:', notification);
      
      // Increment unread count and show dot
      unreadCount++;
      updateNotificationDot(unreadCount);
      
      // Show a prominent toast notification
      showNotificationToast(notification);
      
      // Reload notifications if modal is open
      if (document.getElementById('notifications-modal').style.display === 'block') {
        loadNotifications();
      }
    });

    // Show toast notification
    function showNotificationToast(notification) {
      // Create toast element
      const toast = document.createElement('div');
      toast.className = 'notification-toast';
      toast.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
          <div style="background: #3498db; color: white; padding: 10px; border-radius: 50%;">üì¢</div>
          <div>
            <strong>New Help Request!</strong><br>
            <small>${notification.fromUser.username} needs help with ${notification.subject}</small>
          </div>
        </div>
      `;
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        border-left: 4px solid #3498db;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        max-width: 300px;
        animation: slideIn 0.3s ease-out;
        cursor: pointer;
      `;
      
      toast.onclick = function() {
        openNotificationsModal();
        document.body.removeChild(toast);
      };
      
      document.body.appendChild(toast);
      
      // Auto-remove after 8 seconds
      setTimeout(() => {
        if (toast.parentElement) {
          toast.style.animation = 'slideOut 0.3s ease-out';
          setTimeout(() => toast.remove(), 300);
        }
      }, 8000);
    }

    // Add animation styles for toast
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    `;
    document.head.appendChild(style);

    socket.on('help_request_accepted', (data) => {
      console.log('Help request accepted:', data);
      alert(`Someone accepted your help request for ${data.subject}! Check your chats.`);
      // Redirect to chats page
      setTimeout(() => {
        window.location.href = '/chats.html';
      }, 2000);
    });

    // Poll for notifications every 5 seconds as backup for socket.io
    function startNotificationPolling() {
      setInterval(() => {
        loadNotifications();
      }, 5000);
    }

    // Join socket room when user profile is loaded
    function joinSocketRoom(email) {
      socket.emit('join', email);
    }
  </script>
</body>
</html>
