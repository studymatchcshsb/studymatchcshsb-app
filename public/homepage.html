<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Study Dashboard</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <div class="dashboard-container">
    <aside class="sidebar">
      <!-- Hamburger Menu Icon -->
      <svg class="icon" onclick="toggleMenu()" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
      <!-- Help/Question Icon -->
      <svg class="icon" onclick="openHelpModal()" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>
    </aside>

    <div id="menu-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close-btn" onclick="toggleMenu()">&times;</span>
            <h3><b>Password and Security</b></h3>
            <p>Gmail: <span id="menu-email"></span></p>
            <p>Password: ******** <button onclick="openChangePasswordModal()">Change</button></p>
            <hr>
            <button onclick="logout()">Log Out</button>
        </div>
    </div>

    <div id="change-password-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close-btn" onclick="closeChangePasswordModal()">&times;</span>
            <h3>Change Password</h3>
            <input type="password" id="current-password" placeholder="Current Password">
            <input type="password" id="new-password" placeholder="New Password">
            <input type="password" id="confirm-new-password" placeholder="Confirm New Password">
            <button onclick="changePassword()">Save Changes</button>
            <p id="change-password-message" style="color: red;"></p>
        </div>
    </div>

    <div class="main-content">
      <header class="dashboard-header">
        <div class="header-icons">
          <svg class="icon" onclick="openNotificationsModal()" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg>
          <svg class="icon" onclick="window.location.href='/chats.html'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
        </div>
        <a href="/edit-profile.html" class="header-profile">
          <div class="profile-text">
            <span id="user-name"></span>
            <span id="user-details"></span>
          </div>
          <div class="profile-pic-container">
            <div class="profile-initials" id="profile-initials"></div>
          </div>
        </a>
      </header>

      <main class="dashboard-main">
        <section class="todo-section">
          <div class="list-box" id="todo-list-container">
            <!-- To-do items will be dynamically inserted here -->
          </div>
          <button class="add-list-btn" onclick="openTodoModal()">+</button>
        </section>

        <!-- Add To-Do Modal -->
        <div id="todo-modal" class="modal" style="display:none;">
          <div class="modal-content">
            <span class="close-btn" onclick="closeTodoModal()">&times;</span>
            <h3>Add New To-Do</h3>
            <input type="text" id="todo-title" placeholder="Title (e.g., Quizzes)">
            <textarea id="todo-items" placeholder="Items (one per line)"></textarea>
            <button onclick="addTodo()">Add To-Do</button>
          </div>
        </div>
        <section class="find-section">
          <div class="find-content">
            <div class="speech-bubble">Find a KaStudy!</div>
            <button class="find-btn" onclick="openGradeModal()">Find!</button>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Help Modal -->
  <div id="help-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close-btn" onclick="closeHelpModal()">&times;</span>
      <h3><b>How to use StudyMatch?</b></h3>
      <ol>
        <li>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Curabitur ullamcorper felis in est sodales, nec congue elit ultrices.</li>
        <li>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Curabitur ullamcorper felis in est sodales, nec congue elit ultrices.</li>
        <li>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Curabitur ullamcorper felis in est sodales, nec congue elit ultrices.</li>
        <li>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Curabitur ullamcorper felis in est sodales, nec congue elit ultrices.</li>
        <li>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Curabitur ullamcorper felis in est sodales, nec congue elit ultrices.</li>
      </ol>
      <hr>
      <h4>What do you need help with?</h4>
      <textarea id="help-request" placeholder="Write your suggestions, queries, etc. here..."></textarea>
      <button onclick="submitHelpRequest()">Submit</button>
      <p id="help-message" style="color: green; margin-top: 10px;"></p>
    </div>
  </div>

  <!-- Grade Selection Modal -->
  <div id="grade-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close-btn" onclick="closeGradeModal()">&times;</span>
      <h3>Select Grade Level</h3>
      <div class="selection-grid">
        <button class="selection-btn" onclick="selectGrade(7)">7</button>
        <button class="selection-btn" onclick="selectGrade(8)">8</button>
        <button class="selection-btn" onclick="selectGrade(9)">9</button>
        <button class="selection-btn" onclick="selectGrade(10)">10</button>
      </div>
    </div>
  </div>

  <!-- Subject Selection Modal -->
  <div id="subject-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close-btn" onclick="closeSubjectModal()">&times;</span>
      <h3>Select Subject</h3>
      <div class="selection-grid">
        <button class="selection-btn" onclick="selectSubject('ENGLISH')">ENGLISH</button>
        <button class="selection-btn" onclick="selectSubject('FILIPINO')">FILIPINO</button>
        <button class="selection-btn" onclick="selectSubject('SCIENCE')">SCIENCE</button>
        <button class="selection-btn" onclick="selectSubject('ESP')">ESP</button>
        <button class="selection-btn" onclick="selectSubject('AP')">AP</button>
        <button class="selection-btn" onclick="selectSubject('ICT')">ICT</button>
        <button class="selection-btn" onclick="selectSubject('MAPEH')">MAPEH</button>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmation-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close-btn" onclick="closeConfirmationModal()">&times;</span>
      <h3>Find KaStudy?</h3>
      <div class="confirmation-buttons">
        <button class="confirmation-btn yes-btn" onclick="confirmFind(true)">Yes</button>
        <button class="confirmation-btn no-btn" onclick="confirmFind(false)">No</button>
      </div>
    </div>
  </div>

  <!-- Searching Modal -->
  <div id="searching-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close-btn" onclick="closeSearchingModal()">&times;</span>
      <h3>Searching for the perfect user to help you...</h3>
      <div class="searching-content">
        <div class="spinner"></div>
        <p>Please wait while we find your study buddy.</p>
      </div>
    </div>
  </div>

  <!-- Notifications Modal -->
  <div id="notifications-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close-btn" onclick="closeNotificationsModal()">&times;</span>
      <h3><b>StudyMatch CSHSB</b></h3>
      <p>This is a sample notification. You will receive such notifications from Comsayanos you have matched with. StudyMatch CSHSB will also remind you of its awesome updates.</p>
      <p><i>- Gaea Athena A. Ojeda, S.Y 2025-2026</i></p>
    </div>
  </div>

  <script>
    const backendURL = window.location.origin;

    function openTodoModal() {
      document.getElementById('todo-modal').style.display = 'block';
    }

    function closeTodoModal() {
      document.getElementById('todo-modal').style.display = 'none';
    }

    function openHelpModal() {
      document.getElementById('help-modal').style.display = 'block';
    }

    function closeHelpModal() {
      document.getElementById('help-modal').style.display = 'none';
    }

    async function toggleMenu() {
        const menu = document.getElementById('menu-modal');
        if (menu.style.display === 'block') {
            menu.style.display = 'none';
        } else {
            try {
              const response = await fetch(`${backendURL}/get-profile`);
              if (!response.ok) {
                throw new Error('Failed to fetch profile');
              }
              const data = await response.json();
              if (data.success) {
                document.getElementById('menu-email').innerText = data.user.email;
              }
            } catch (error) {
              console.error("Error fetching profile:", error);
            }
            menu.style.display = 'block';
        }
    }

    function openChangePasswordModal() {
        document.getElementById('change-password-modal').style.display = 'block';
    }

    function closeChangePasswordModal() {
        document.getElementById('change-password-modal').style.display = 'none';
    }

    async function fetchTodos() {
      try {
        const response = await fetch(`${backendURL}/get-todos`);
        if (!response.ok) {
          throw new Error('Failed to fetch to-dos.');
        }
        const todos = await response.json();
        const container = document.getElementById('todo-list-container');
        container.innerHTML = ''; // Clear existing todos
        todos.forEach(todo => {
          const todoEl = document.createElement('div');
          todoEl.className = 'todo-item';
          todoEl.innerHTML = `
            <h3>
              ${todo.title}
              <span class="delete-btn" onclick="deleteTodo('${todo._id}')">&times;</span>
            </h3>
            <p>${todo.items.join('<br>')}</p>
          `;
          container.appendChild(todoEl);
        });
      } catch (error) {
        console.error("Error fetching todos:", error);
        // Optionally show an error to the user
      }
    }

    async function addTodo() {
      const title = document.getElementById('todo-title').value;
      const items = document.getElementById('todo-items').value.split('\n').filter(item => item.trim() !== '');

      if (!title || items.length === 0) {
        alert("Please provide a title and at least one item.");
        return;
      }

      try {
        const response = await fetch(`${backendURL}/add-todo`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, items })
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Failed to add to-do');
        }

        closeTodoModal();
        fetchTodos(); // Refresh the list
      } catch (error) {
        console.error("Error adding todo:", error);
        alert(`Error: ${error.message}`);
      }
    }
  
    async function deleteTodo(id) {
      if (!confirm("Are you sure you want to delete this to-do list?")) {
        return;
      }
  
      try {
        const response = await fetch(`${backendURL}/delete-todo/${id}`, { method: 'DELETE' });
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Failed to delete to-do');
        }
        fetchTodos(); // Refresh the list
      } catch (error) {
        console.error("Error deleting todo:", error);
        alert(`Error: ${error.message}`);
      }
    }
  
    async function submitHelpRequest() {
      const message = document.getElementById('help-request').value;
      if (!message.trim()) {
        alert('Please enter your query or suggestion.');
        return;
      }
  
      try {
        const response = await fetch(`${backendURL}/send-help-request`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });
  
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Failed to send help request.');
        }
  
        document.getElementById('help-request').value = '';
        const helpMessageEl = document.getElementById('help-message');
        helpMessageEl.innerText = "Thank you for letting us know. We'll get back to you with an update. Kindly check your email address for our response.";
        setTimeout(() => {
          closeHelpModal();
          helpMessageEl.innerText = '';
        }, 5000);
  
      } catch (error) {
        console.error("Error sending help request:", error);
        alert(`Error: ${error.message}`);
      }
    }

    async function changePassword() {
        const currentPassword = document.getElementById('current-password').value;
        const newPassword = document.getElementById('new-password').value;
        const confirmNewPassword = document.getElementById('confirm-new-password').value;
        const messageEl = document.getElementById('change-password-message');

        if (newPassword !== confirmNewPassword) {
            messageEl.innerText = "New passwords do not match.";
            return;
        }

        try {
            const response = await fetch(`${backendURL}/change-password`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ currentPassword, newPassword })
            });

            const data = await response.json();

            if (data.success) {
                messageEl.style.color = 'green';
                messageEl.innerText = "Password changed successfully!";
                setTimeout(() => {
                    closeChangePasswordModal();
                    messageEl.innerText = '';
                    messageEl.style.color = 'red';
                }, 2000);
            } else {
                messageEl.innerText = data.message;
            }
        } catch (error) {
            console.error("Error changing password:", error);
            messageEl.innerText = "An error occurred. Please try again.";
        }
    }

    async function logout() {
        if (confirm("Save password for future log-ins?")) {
            // This is where you would implement logic to save the password,
            // for example, in localStorage. For now, we'll just log out.
            console.log("User chose to save password.");
        } else {
            console.log("User chose not to save password.");
        }

        try {
            await fetch(`${backendURL}/logout`, { method: 'POST' });
            window.location.href = '/index.html';
        } catch (error) {
            console.error("Error logging out:", error);
        }
    }

    // Find Study Buddy Modals
    let selectedGrade = null;
    let selectedSubject = null;

    function openGradeModal() {
        document.getElementById('grade-modal').style.display = 'block';
    }

    function closeGradeModal() {
        document.getElementById('grade-modal').style.display = 'none';
    }

    function selectGrade(grade) {
        selectedGrade = grade;
        closeGradeModal();
        openSubjectModal();
    }

    function openSubjectModal() {
        document.getElementById('subject-modal').style.display = 'block';
    }

    function closeSubjectModal() {
        document.getElementById('subject-modal').style.display = 'none';
        selectedGrade = null;
    }

    function selectSubject(subject) {
        selectedSubject = subject;
        closeSubjectModal();
        openConfirmationModal();
    }

    function openConfirmationModal() {
        document.getElementById('confirmation-modal').style.display = 'block';
    }

    function closeConfirmationModal() {
        document.getElementById('confirmation-modal').style.display = 'none';
    }

    function confirmFind(yes) {
        closeConfirmationModal();
        if (yes) {
            openSearchingModal();
        } else {
            // Go back to homepage - close all modals
            closeGradeModal();
            closeSubjectModal();
            closeSearchingModal();
        }
    }

    function openSearchingModal() {
        document.getElementById('searching-modal').style.display = 'block';
    }

    function closeSearchingModal() {
        document.getElementById('searching-modal').style.display = 'none';
        // Go back to confirmation modal
        openConfirmationModal();
    }

    function openNotificationsModal() {
        document.getElementById('notifications-modal').style.display = 'block';
    }

    function closeNotificationsModal() {
        document.getElementById('notifications-modal').style.display = 'none';
    }

    // Fetch user profile and set initials
    async function fetchUserProfile() {
      try {
        const response = await fetch(`${backendURL}/get-profile`);
        if (!response.ok) {
          throw new Error('Failed to fetch profile');
        }
        const data = await response.json();
        if (data.success) {
          // Set user name and details
          document.getElementById('user-name').innerText = `${data.user.name} ${data.user.surname}`;
          document.getElementById('user-details').innerText = `${data.user.grade} - ${data.user.section}`;
          
          // Set profile initials
          const initials = data.user.name.charAt(0).toUpperCase();
          document.getElementById('profile-initials').innerText = initials;
        }
      } catch (error) {
        console.error("Error fetching profile:", error);
      }
    }

    // Fetch todos and user profile when the page loads
    document.addEventListener('DOMContentLoaded', function() {
      fetchTodos();
      fetchUserProfile();
    });
  </script>
</body>
</html>