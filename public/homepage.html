<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Study Dashboard</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <div class="dashboard-container">
    <aside class="sidebar">
      <!-- Hamburger Menu Icon -->
      <svg class="icon" onclick="toggleMenu()" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
      <!-- Help/Question Icon -->
      <svg class="icon" onclick="openHelpModal()" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>
    </aside>

    <div id="menu-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close-btn" onclick="toggleMenu()">&times;</span>
            <h3><b>Password and Security</b></h3>
            <p>Gmail: <span id="menu-email"></span></p>
            <p>Password: ******** <button onclick="openChangePasswordModal()">Change</button></p>
            <hr>
            <button onclick="logout()">Log Out</button>
        </div>
    </div>

    <div id="change-password-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close-btn" onclick="closeChangePasswordModal()">&times;</span>
            <h3>Change Password</h3>
            <input type="password" id="current-password" placeholder="Current Password">
            <input type="password" id="new-password" placeholder="New Password">
            <input type="password" id="confirm-new-password" placeholder="Confirm New Password" oninput="validateNewPasswords()">
            <p id="password-validation-message" style="margin: 5px 0; font-size: 0.9em;"></p>
            <button onclick="changePassword()">Save Changes</button>
            <p id="change-password-message" style="color: red;"></p>
        </div>
    </div>

    <div class="main-content">
      <header class="dashboard-header">
        <div class="header-icons">
          <svg class="icon" onclick="openNotificationsModal()" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg>
          <svg class="icon" onclick="window.location.href='/chats.html'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
        </div>

        <!-- Find Study Buddies Section in Header -->
        <div class="header-search">
          <div class="header-search-content">
            <div class="search-container">
              <input type="text" id="user-search" placeholder="Find study buddies..." oninput="searchUsers()">
              <button onclick="searchUsers()">üîç</button>
            </div>
            <div id="search-results" class="header-search-results">
              <!-- Search results will appear here -->
            </div>
          </div>
        </div>

        <a href="/edit-profile.html" class="header-profile">
          <div class="profile-text">
            <span id="user-name"></span>
            <span id="user-details"></span>
          </div>
          <div class="profile-pic-container">
            <div class="profile-initials" id="profile-initials"></div>
          </div>
        </a>
      </header>

      <main class="dashboard-main">
        <section class="todo-section">
          <div class="list-box" id="todo-list-container">
            <!-- To-do items will be dynamically inserted here -->
          </div>
          <button class="add-list-btn" onclick="openTodoModal()">+</button>
        </section>

        <!-- Profile Completion Reminder -->
        <div id="profile-reminder" class="profile-reminder" style="display: none;">
          <div class="reminder-content">
            <div class="reminder-icon">üìù</div>
            <div class="reminder-text">
              <strong>STUDYMATCH CSHSB:</strong> Finish setting up your profile by updating the subjects you are good at and need help with. You can see this through clicking your profile at the top right corner of your Homepage.
            </div>
          </div>
        </div>

        <!-- Add To-Do Modal -->
        <div id="todo-modal" class="modal" style="display:none;">
          <div class="modal-content">
            <span class="close-btn" onclick="closeTodoModal()">&times;</span>
            <h3>Add New To-Do</h3>
            <input type="text" id="todo-title" placeholder="Title (e.g., Quizzes)">
            <textarea id="todo-items" placeholder="Items (one per line)"></textarea>
            <button onclick="addTodo()">Add To-Do</button>
          </div>
        </div>
      </main>

      <!-- Find a KaStudy - Lower Right Corner -->
      <section class="find-kastudy-corner">
        <div class="find-content">
          <div class="speech-bubble">Find a KaStudy!</div>
          <button class="find-btn" onclick="openGradeModal()">Find!</button>
        </div>
      </section>
    </div>
  </div>

  <!-- Help Modal -->
  <div id="help-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close-btn" onclick="closeHelpModal()">&times;</span>
      <h3><b>How to use StudyMatch?</b></h3>
      <ol>
        <li>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Curabitur ullamcorper felis in est sodales, nec congue elit ultrices.</li>
        <li>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Curabitur ullamcorper felis in est sodales, nec congue elit ultrices.</li>
        <li>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Curabitur ullamcorper felis in est sodales, nec congue elit ultrices.</li>
        <li>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Curabitur ullamcorper felis in est sodales, nec congue elit ultrices.</li>
        <li>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Curabitur ullamcorper felis in est sodales, nec congue elit ultrices.</li>
      </ol>
      <hr>
      <h4>What do you need help with?</h4>
      <textarea id="help-request" placeholder="Write your suggestions, queries, etc. here..."></textarea>
      <button onclick="submitHelpRequest()">Submit</button>
      <p id="help-message" style="color: green; margin-top: 10px;"></p>
    </div>
  </div>

  <!-- Grade Selection Modal -->
  <div id="grade-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close-btn" onclick="closeGradeModal()">&times;</span>
      <h3>Select Grade Level</h3>
      <div class="selection-grid">
        <button class="selection-btn" onclick="selectGrade(7)">7</button>
        <button class="selection-btn" onclick="selectGrade(8)">8</button>
        <button class="selection-btn" onclick="selectGrade(9)">9</button>
        <button class="selection-btn" onclick="selectGrade(10)">10</button>
      </div>
    </div>
  </div>

  <!-- Subject Selection Modal -->
  <div id="subject-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close-btn" onclick="closeSubjectModal()">&times;</span>
      <h3>Select Subject</h3>
      <div class="selection-grid">
        <button class="selection-btn" onclick="selectSubject('ENGLISH')">ENGLISH</button>
        <button class="selection-btn" onclick="selectSubject('FILIPINO')">FILIPINO</button>
        <button class="selection-btn" onclick="selectSubject('SCIENCE')">SCIENCE</button>
        <button class="selection-btn" onclick="selectSubject('ESP')">ESP</button>
        <button class="selection-btn" onclick="selectSubject('AP')">AP</button>
        <button class="selection-btn" onclick="selectSubject('ICT')">ICT</button>
        <button class="selection-btn" onclick="selectSubject('MAPEH')">MAPEH</button>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmation-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close-btn" onclick="closeConfirmationModal()">&times;</span>
      <h3>Find KaStudy?</h3>
      <div class="confirmation-buttons">
        <button class="confirmation-btn yes-btn" onclick="confirmFind(true)">Yes</button>
        <button class="confirmation-btn no-btn" onclick="confirmFind(false)">No</button>
      </div>
    </div>
  </div>


  <!-- Notifications Modal -->
  <div id="notifications-modal" class="modal" style="display:none;">
      <div class="modal-content">
          <span class="close-btn" onclick="closeNotificationsModal()">&times;</span>
          <h3><b>StudyMatch CSHSB</b></h3>
          <div id="notifications-list">
              <!-- Notifications will be loaded here -->
          </div>
          <div id="no-notifications" style="text-align: center; color: #666; padding: 20px;">
              <p>No notifications yet.</p>
              <p>Help requests from classmates will appear here!</p>
          </div>
      </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const backendURL = window.location.origin;
    const socket = io();

    function openTodoModal() {
      document.getElementById('todo-modal').style.display = 'block';
    }

    function closeTodoModal() {
      document.getElementById('todo-modal').style.display = 'none';
    }

    function openHelpModal() {
      document.getElementById('help-modal').style.display = 'block';
    }

    function closeHelpModal() {
      document.getElementById('help-modal').style.display = 'none';
    }

    async function toggleMenu() {
        const menu = document.getElementById('menu-modal');
        if (menu.style.display === 'block') {
            menu.style.display = 'none';
        } else {
            try {
              const response = await fetch(`${backendURL}/get-profile`);
              if (!response.ok) {
                throw new Error('Failed to fetch profile');
              }
              const data = await response.json();
              if (data.success) {
                document.getElementById('menu-email').innerText = data.user.email;
              }
            } catch (error) {
              console.error("Error fetching profile:", error);
            }
            menu.style.display = 'block';
        }
    }

    function openChangePasswordModal() {
        document.getElementById('change-password-modal').style.display = 'block';
    }

    function closeChangePasswordModal() {
        document.getElementById('change-password-modal').style.display = 'none';
    }

    async function fetchTodos() {
      try {
        const response = await fetch(`${backendURL}/get-todos`);
        if (!response.ok) {
          throw new Error('Failed to fetch to-dos.');
        }
        const todos = await response.json();
        const container = document.getElementById('todo-list-container');
        container.innerHTML = ''; // Clear existing todos
        todos.forEach(todo => {
          const todoEl = document.createElement('div');
          todoEl.className = 'todo-item';
          todoEl.innerHTML = `
            <h3>
              ${todo.title}
              <span class="delete-btn" onclick="deleteTodo('${todo._id}')">&times;</span>
            </h3>
            <p>${todo.items.join('<br>')}</p>
          `;
          container.appendChild(todoEl);
        });
      } catch (error) {
        console.error("Error fetching todos:", error);
        // Optionally show an error to the user
      }
    }

    async function addTodo() {
      const title = document.getElementById('todo-title').value;
      const items = document.getElementById('todo-items').value.split('\n').filter(item => item.trim() !== '');

      if (!title || items.length === 0) {
        alert("Please provide a title and at least one item.");
        return;
      }

      try {
        const response = await fetch(`${backendURL}/add-todo`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, items })
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Failed to add to-do');
        }

        closeTodoModal();
        fetchTodos(); // Refresh the list
      } catch (error) {
        console.error("Error adding todo:", error);
        alert(`Error: ${error.message}`);
      }
    }
  
    async function deleteTodo(id) {
      if (!confirm("Are you sure you want to delete this to-do list?")) {
        return;
      }
  
      try {
        const response = await fetch(`${backendURL}/delete-todo/${id}`, { method: 'DELETE' });
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Failed to delete to-do');
        }
        fetchTodos(); // Refresh the list
      } catch (error) {
        console.error("Error deleting todo:", error);
        alert(`Error: ${error.message}`);
      }
    }
  
    async function submitHelpRequest() {
      const message = document.getElementById('help-request').value;
      if (!message.trim()) {
        alert('Please enter your query or suggestion.');
        return;
      }
  
      try {
        const response = await fetch(`${backendURL}/send-help-request`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });
  
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Failed to send help request.');
        }
  
        document.getElementById('help-request').value = '';
        const helpMessageEl = document.getElementById('help-message');
        helpMessageEl.innerText = "Thank you for letting us know. We'll get back to you with an update. Kindly check your email address for our response.";
        setTimeout(() => {
          closeHelpModal();
          helpMessageEl.innerText = '';
        }, 5000);
  
      } catch (error) {
        console.error("Error sending help request:", error);
        alert(`Error: ${error.message}`);
      }
    }

    function validateNewPasswords() {
        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-new-password').value;
        const messageEl = document.getElementById('password-validation-message');
        const confirmInput = document.getElementById('confirm-new-password');

        if (confirmPassword === '') {
            messageEl.innerText = '';
            confirmInput.style.borderColor = '';
            return;
        }

        if (newPassword === confirmPassword) {
            messageEl.innerText = '‚úì Passwords match!';
            messageEl.style.color = 'green';
            confirmInput.style.borderColor = 'green';
        } else {
            messageEl.innerText = '‚úó Passwords do not match';
            messageEl.style.color = 'red';
            confirmInput.style.borderColor = 'red';
        }
    }

    async function changePassword() {
        const currentPassword = document.getElementById('current-password').value;
        const newPassword = document.getElementById('new-password').value;
        const confirmNewPassword = document.getElementById('confirm-new-password').value;
        const messageEl = document.getElementById('change-password-message');

        if (newPassword !== confirmNewPassword) {
            messageEl.innerText = "New passwords do not match.";
            return;
        }

        try {
            const response = await fetch(`${backendURL}/change-password`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ currentPassword, newPassword })
            });

            const data = await response.json();

            if (data.success) {
                messageEl.style.color = 'green';
                messageEl.innerText = "Password changed successfully!";
                setTimeout(() => {
                    closeChangePasswordModal();
                    messageEl.innerText = '';
                    messageEl.style.color = 'red';
                }, 2000);
            } else {
                messageEl.innerText = data.message;
            }
        } catch (error) {
            console.error("Error changing password:", error);
            messageEl.innerText = "An error occurred. Please try again.";
        }
    }

    async function logout() {
        if (confirm("Save password for future log-ins?")) {
            // This is where you would implement logic to save the password,
            // for example, in localStorage. For now, we'll just log out.
            console.log("User chose to save password.");
        } else {
            console.log("User chose not to save password.");
        }

        try {
            await fetch(`${backendURL}/logout`, { method: 'POST' });
            window.location.href = '/index.html';
        } catch (error) {
            console.error("Error logging out:", error);
        }
    }

    // Find Study Buddy Modals
    let selectedGrade = null;
    let selectedSubject = null;

    function openGradeModal() {
        document.getElementById('grade-modal').style.display = 'block';
    }

    function closeGradeModal() {
        document.getElementById('grade-modal').style.display = 'none';
    }

    function selectGrade(grade) {
        selectedGrade = grade;
        closeGradeModal();
        openSubjectModal();
    }

    function openSubjectModal() {
        document.getElementById('subject-modal').style.display = 'block';
    }

    function closeSubjectModal() {
        document.getElementById('subject-modal').style.display = 'none';
        selectedGrade = null;
    }

    function selectSubject(subject) {
        selectedSubject = subject;
        closeSubjectModal();
        openConfirmationModal();
    }

    function openConfirmationModal() {
        document.getElementById('confirmation-modal').style.display = 'block';
    }

    function closeConfirmationModal() {
        document.getElementById('confirmation-modal').style.display = 'none';
    }

    async function confirmFind(yes) {
        closeConfirmationModal();
        if (yes) {
            // Send help request to all users in the same grade
            try {
                const response = await fetch(`${backendURL}/send-help-request`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        grade: selectedGrade,
                        subject: selectedSubject
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to send help request');
                }

                const data = await response.json();
                alert(data.message || 'Help request sent successfully!');

                // Close all modals
                closeGradeModal();
                closeSubjectModal();

                // Reset selections
                selectedGrade = null;
                selectedSubject = null;

            } catch (error) {
                console.error("Error sending help request:", error);
                alert('Error sending help request. Please try again.');
            }
        } else {
            // Go back to homepage - close all modals
            closeGradeModal();
            closeSubjectModal();
            // Reset selections
            selectedGrade = null;
            selectedSubject = null;
        }
    }

    function openSearchingModal() {
        document.getElementById('searching-modal').style.display = 'block';
    }


    function openNotificationsModal() {
        document.getElementById('notifications-modal').style.display = 'block';
        loadNotifications();
    }

    function closeNotificationsModal() {
        document.getElementById('notifications-modal').style.display = 'none';
    }

    // Load notifications
    async function loadNotifications() {
        try {
            const response = await fetch(`${backendURL}/get-notifications`);
            if (!response.ok) {
                throw new Error('Failed to fetch notifications');
            }
            const data = await response.json();
            displayNotifications(data.notifications || []);
        } catch (error) {
            console.error("Error loading notifications:", error);
        }
    }

    // Display notifications in the modal
    function displayNotifications(notifications) {
        const container = document.getElementById('notifications-list');
        const noNotifications = document.getElementById('no-notifications');

        if (notifications.length === 0) {
            container.innerHTML = '';
            noNotifications.style.display = 'block';
            return;
        }

        noNotifications.style.display = 'none';
        container.innerHTML = '';

        notifications.forEach(notification => {
            if (notification.type === 'help_request') {
                const notificationDiv = document.createElement('div');
                notificationDiv.className = 'notification-item';
                notificationDiv.innerHTML = `
                    <div class="notification-content">
                        <strong>STUDYMATCH CSHSB</strong><br>
                        Hi! <strong>${notification.fromUser.name} ${notification.fromUser.surname}</strong> needs help with <strong>${notification.subject}</strong>.
                        Would you like to help him/her?
                    </div>
                    <div class="notification-actions">
                        <button class="help-btn yes-btn" onclick="respondToHelpRequest('${notification.id}', 'accept', '${notification.fromUser.email}', '${notification.subject}')">Yes</button>
                        <button class="help-btn no-btn" onclick="respondToHelpRequest('${notification.id}', 'decline')">No</button>
                    </div>
                `;
                container.appendChild(notificationDiv);
            } else if (notification.type === 'friend_request') {
                const notificationDiv = document.createElement('div');
                notificationDiv.className = 'notification-item';
                notificationDiv.innerHTML = `
                    <div class="notification-content">
                        <strong>${notification.fromUser.name} ${notification.fromUser.surname}</strong> sent you a friend request.
                    </div>
                    <div class="notification-actions">
                        <button class="help-btn yes-btn" onclick="respondToFriendRequest('${notification.id}', 'accept', '${notification.fromUser.email}', '${notification.fromUser.name} ${notification.fromUser.surname}')">Accept</button>
                        <button class="help-btn no-btn" onclick="respondToFriendRequest('${notification.id}', 'decline')">Deny</button>
                    </div>
                `;
                container.appendChild(notificationDiv);
            }
        });
    }

    // Handle help request response
    async function respondToHelpRequest(notificationId, response, requesterEmail, subject) {
        try {
            const responseData = await fetch(`${backendURL}/respond-help-request`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    notificationId,
                    response,
                    requesterEmail,
                    subject
                })
            });

            if (!responseData.ok) {
                throw new Error('Failed to respond to help request');
            }

            const data = await responseData.json();

            if (response === 'accept') {
                alert(data.message);
                // Redirect to chats page
                window.location.href = '/chats.html';
            } else {
                // Reload notifications
                loadNotifications();
            }
        } catch (error) {
            console.error("Error responding to help request:", error);
            alert('Error processing your response. Please try again.');
        }
    }

    // Handle friend request response
    async function respondToFriendRequest(notificationId, response, requesterEmail, accepterName) {
        try {
            const responseData = await fetch(`${backendURL}/respond-friend-request`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    notificationId,
                    response,
                    requesterEmail,
                    accepterName
                })
            });

            if (!responseData.ok) {
                throw new Error('Failed to respond to friend request');
            }

            const data = await responseData.json();

            if (response === 'accept') {
                alert(data.message);
                // Redirect to chats page
                window.location.href = '/chats.html';
            } else {
                // Reload notifications
                loadNotifications();
            }
        } catch (error) {
            console.error("Error responding to friend request:", error);
            alert('Error processing your response. Please try again.');
        }
    }

    // User search and friend functionality
    async function searchUsers() {
        const query = document.getElementById('user-search').value.trim();
        const resultsDiv = document.getElementById('search-results');

        if (query.length < 2) {
            resultsDiv.classList.remove('active');
            resultsDiv.innerHTML = '';
            return;
        }

        try {
            const response = await fetch(`${backendURL}/search-users?q=${encodeURIComponent(query)}`);
            if (!response.ok) {
                throw new Error('Failed to search users');
            }
            const data = await response.json();

            resultsDiv.innerHTML = '';

            if (data.users && data.users.length > 0) {
                data.users.forEach(user => {
                    const userDiv = document.createElement('div');
                    userDiv.className = 'user-result';

                    const avatar = user.name.charAt(0).toUpperCase();
                    const friendStatus = getFriendStatus(user.email);

                    userDiv.innerHTML = `
                        <div class="user-avatar">${avatar}</div>
                        <div class="user-info">
                            <div class="user-name">${user.name} ${user.surname}</div>
                            <div class="user-details">Grade ${user.grade} - ${user.section}</div>
                        </div>
                        <button class="add-friend-btn" onclick="addFriend('${user.email}')" id="friend-btn-${user.email}">
                            ${friendStatus.text}
                        </button>
                    `;

                    const btn = userDiv.querySelector('.add-friend-btn');
                    btn.className = `add-friend-btn ${friendStatus.class}`;

                    resultsDiv.appendChild(userDiv);
                });
                resultsDiv.classList.add('active');
            } else {
                resultsDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No users found</p>';
                resultsDiv.classList.add('active');
            }
        } catch (error) {
            console.error("Error searching users:", error);
            resultsDiv.innerHTML = '<p style="text-align: center; color: #e74c3c; padding: 20px;">Error searching users</p>';
            resultsDiv.classList.add('active');
        }
    }

    // Close search results when clicking outside
    document.addEventListener('click', function(event) {
        const searchContainer = document.querySelector('.header-search');
        const resultsDiv = document.getElementById('search-results');

        if (!searchContainer.contains(event.target)) {
            resultsDiv.classList.remove('active');
        }
    });

    function getFriendStatus(email) {
        // This would normally check against a friends list
        // For now, return default status
        return { text: 'Add Friend', class: '' };
    }

    async function addFriend(email) {
        const btn = document.getElementById(`friend-btn-${email}`);

        try {
            const response = await fetch(`${backendURL}/add-friend`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ friendEmail: email })
            });

            if (!response.ok) {
                throw new Error('Failed to add friend');
            }

            const data = await response.json();

            if (data.success) {
                btn.textContent = 'Request Sent';
                btn.className = 'add-friend-btn pending';
                btn.disabled = true;
            } else {
                alert(data.message || 'Failed to add friend');
            }
        } catch (error) {
            console.error("Error adding friend:", error);
            alert('Error adding friend. Please try again.');
        }
    }

    // Fetch user profile and set initials
    async function fetchUserProfile() {
      try {
        const response = await fetch(`${backendURL}/get-profile`);
        if (!response.ok) {
          throw new Error('Failed to fetch profile');
        }
        const data = await response.json();
        if (data.success) {
          // Set user name and details
          document.getElementById('user-name').innerText = `${data.user.name} ${data.user.surname}`;
          document.getElementById('user-details').innerText = `${data.user.grade} - ${data.user.section}`;

          // Set profile initials
          const initials = data.user.name.charAt(0).toUpperCase();
          document.getElementById('profile-initials').innerText = initials;

          // Join socket room for real-time notifications
          joinSocketRoom(data.user.email);

          // Check profile completion status
          checkProfileCompletion(data.user);
        }
      } catch (error) {
        console.error("Error fetching profile:", error);
      }
    }

    // Check if user has completed their profile (has strengths and weaknesses)
    function checkProfileCompletion(user) {
      const reminder = document.getElementById('profile-reminder');

      // Show reminder if user doesn't have strengths or weaknesses set
      if (!user.strengths || user.strengths.length === 0 || !user.weaknesses || user.weaknesses.length === 0) {
        reminder.style.display = 'block';
      } else {
        reminder.style.display = 'none';
      }
    }

    // Fetch todos and user profile when the page loads
    document.addEventListener('DOMContentLoaded', function() {
      fetchTodos();
      fetchUserProfile();
    });

    // Socket.io event listeners for real-time notifications
    socket.on('new_notification', (notification) => {
      console.log('New notification received:', notification);
      // Show a browser notification if permitted
      if (Notification.permission === 'granted') {
        new Notification('StudyMatch CSHSB', {
          body: `${notification.fromUser.name} needs help with ${notification.subject}`,
          icon: '/favicon.ico'
        });
      }
      // Reload notifications if modal is open
      if (document.getElementById('notifications-modal').style.display === 'block') {
        loadNotifications();
      }
    });

    socket.on('help_request_accepted', (data) => {
      console.log('Help request accepted:', data);
      alert(`Someone accepted your help request for ${data.subject}! Check your chats.`);
      // Redirect to chats page
      setTimeout(() => {
        window.location.href = '/chats.html';
      }, 2000);
    });

    socket.on('friend_request_accepted', (data) => {
      console.log('Friend request accepted:', data);
      alert(`${data.accepterName} accepted your friend request! You can now chat with each other.`);
      // Redirect to chats page
      setTimeout(() => {
        window.location.href = '/chats.html';
      }, 2000);
    });

    // Join socket room when user profile is loaded
    function joinSocketRoom(email) {
      socket.emit('join', email);
    }
  </script>
</body>
</html>