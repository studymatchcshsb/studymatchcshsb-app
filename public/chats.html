<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chats</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <div class="dashboard-container">
    <div class="main-content">
      <header class="dashboard-header">
        <div class="header-icons">
          <svg class="icon" onclick="window.location.href='/homepage.html'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
        </div>
        <div class="chats-title">CHATS</div>
        <a href="/edit-profile.html" class="header-profile">
          <div class="profile-text">
            <span id="user-name"></span>
            <span id="user-details"></span>
          </div>
          <div class="profile-pic-container">
            <div class="profile-initials" id="profile-initials"></div>
          </div>
        </a>
      </header>

      <main class="dashboard-main">
        <section class="chats-section">
          <div class="chat-list" id="chat-list">
            <!-- Friends will be loaded here -->
            <div id="no-friends-message" style="text-align: center; color: #666; padding: 40px;">
              <p>No friends yet. Add some friends from the homepage to start chatting!</p>
            </div>
          </div>
        </section>
        <section class="message-section">
          <div class="messages" id="messages"></div>
          <div class="message-input">
            <input type="text" id="message-input" placeholder="Type a message..." onkeypress="if(event.key === 'Enter') sendMessage()">
            <button onclick="sendMessage()">Send</button>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const backendURL = window.location.origin;
    const socket = io();

    let currentUserEmail = '';
    let selectedRecipient = '';
    let userNames = {}; // Store user names for display

    // Fetch user profile and set initials
    async function fetchUserProfile() {
      try {
        const response = await fetch(`${backendURL}/get-profile`);
        if (!response.ok) {
          throw new Error('Failed to fetch profile');
        }
        const data = await response.json();
        if (data.success) {
          currentUserEmail = data.user.email;
          // Set user name and details
          document.getElementById('user-name').innerText = `${data.user.name} ${data.user.surname}`;
          document.getElementById('user-details').innerText = `${data.user.grade} - ${data.user.section}`;

          // Set profile initials
          const initials = data.user.name.charAt(0).toUpperCase();
          document.getElementById('profile-initials').innerText = initials;

          // Join socket room
          socket.emit('join', currentUserEmail);
        }
      } catch (error) {
        console.error("Error fetching profile:", error);
      }
    }

    // Select a chat recipient and load message history
    async function selectChat(recipientEmail) {
      selectedRecipient = recipientEmail;
      const messagesDiv = document.getElementById('messages');
      messagesDiv.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">Loading messages...</div>';

      try {
        const response = await fetch(`${backendURL}/get-messages/${recipientEmail}`);
        if (!response.ok) {
          throw new Error('Failed to fetch messages');
        }
        const data = await response.json();

        messagesDiv.innerHTML = ''; // Clear loading message

        if (data.messages && data.messages.length > 0) {
          data.messages.forEach(msg => {
            displayMessage(msg);
          });
        } else {
          messagesDiv.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No messages yet. Start the conversation!</div>';
        }
      } catch (error) {
        console.error("Error loading messages:", error);
        messagesDiv.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">Failed to load messages.</div>';
      }
    }

    // Display a message in the chat
    function displayMessage(msg) {
      const messagesDiv = document.getElementById('messages');
      const messageEl = document.createElement('div');
      messageEl.className = 'message';

      const isFromCurrentUser = msg.from === currentUserEmail;
      const displayName = isFromCurrentUser ? 'You' : (userNames[msg.from] || msg.from);

      messageEl.innerHTML = `<strong>${displayName}:</strong> ${msg.message} <small>${new Date(msg.timestamp).toLocaleTimeString()}</small>`;
      messagesDiv.appendChild(messageEl);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Handle sending messages
    function sendMessage() {
      const messageInput = document.getElementById('message-input');
      const message = messageInput.value.trim();
      if (message && selectedRecipient) {
        socket.emit('send message', { to: selectedRecipient, message });
        messageInput.value = '';
      }
    }

    // Listen for incoming messages
    socket.on('receive message', (data) => {
      // Store the user name for future reference
      if (data.fromEmail && data.from !== 'You') {
        userNames[data.fromEmail] = data.from;
      }

      // Only display if this message is for the currently selected recipient
      if (selectedRecipient && (data.fromEmail === selectedRecipient || data.fromEmail === currentUserEmail)) {
        displayMessage({
          from: data.fromEmail,
          message: data.message,
          timestamp: data.timestamp
        });
      }
    });

    // Load friends list
    async function loadFriends() {
      try {
        const response = await fetch(`${backendURL}/get-friends`);
        if (!response.ok) {
          throw new Error('Failed to fetch friends');
        }
        const data = await response.json();

        const chatList = document.getElementById('chat-list');
        const noFriendsMessage = document.getElementById('no-friends-message');

        if (data.friends && data.friends.length > 0) {
          noFriendsMessage.style.display = 'none';
          chatList.innerHTML = '';

          data.friends.forEach(friend => {
            // Store user names for message display
            userNames[friend.email] = `${friend.name} ${friend.surname}`;

            const chatItem = document.createElement('div');
            chatItem.className = 'chat-item';
            chatItem.onclick = () => selectChat(friend.email);

            const avatar = friend.name.charAt(0).toUpperCase();

            chatItem.innerHTML = `
              <div class="chat-avatar">${avatar}</div>
              <div class="chat-info">
                <div class="chat-name">${friend.name} ${friend.surname}</div>
                <div class="chat-last-message">Click to start chatting</div>
              </div>
            `;

            chatList.appendChild(chatItem);
          });
        } else {
          noFriendsMessage.style.display = 'block';
        }
      } catch (error) {
        console.error("Error loading friends:", error);
      }
    }

    // Fetch user profile and friends when the page loads
    document.addEventListener('DOMContentLoaded', function() {
      fetchUserProfile();
      loadFriends();
    });
  </script>
</body>
</html>