<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>StudyMatch CSHS Login</title>
  <link relB -="stylesheet" href="/studymatch/public/css/style.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="tailwind.config.js"></script>
</head>
<body class="min-h-screen" style="background: linear-gradient(135deg, #1B5E20 0%, #2E7D32 30%, #4CAF50 60%, #FFD700 100%);">
<div id="loadingOverlay">
<div class="loader">
    <div class="bar1"></div>
    <div class="bar2"></div>
    <div class="bar3"></div>
    <div class="bar4"></div>
    <div class="bar5"></div>
    <div class="bar6"></div>
    <div class="bar7"></div>
    <div class="bar8"></div>
    <div class="bar9"></div>
    <div class="bar10"></div>
    <div class="bar11"></div>
    <div class="bar12"></div>
</div>
</div>

<section class="min-h-screen flex items-center justify-center px-6 py-8">
  <div class="w-full bg-white/95 backdrop-blur rounded-2xl shadow-2xl md:mt-0 sm:max-w-md xl:p-0 border-2 border-yellow-400">
          <div class="p-6 space-y-4 md:space-y-6 sm:p-8" id="register-section">
              <h1 class="text-xl font-bold leading-tight tracking-tight text-gray-900 md:text-2xl text-center text-green-800">
                  <span class="text-yellow-600">✦</span> StudyMatch CSHSB <span class="text-yellow-600">✦</span>
              </h1>
              <h2 class="text-lg font-semibold text-center text-gray-600 mb-6">Create Your Account</h2>
              
              <!-- Step 1: Email -->
              <div id="step-email">
                  <label for="email" class="block mb-2 text-sm font-medium text-gray-900">Your email</label>
                  <div class="relative">
                      <input type="email" id="email" class="bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-green-500 focus:border-green-500 block w-full p-2.5" placeholder="your.email@cshsb.edu.ph" required autocomplete="off">
                  </div>
                  <button type="button" id="sendOtpBtn" class="w-full mt-4 text-white bg-gradient-to-r from-green-700 to-green-500 hover:from-green-600 hover:to-green-400 focus:ring-4 focus:outline-none focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center shadow-lg transform transition hover:-translate-y-0.5">Send OTP to Email</button>
                  <p class="text-sm text-center mt-4 text-gray-600">
                      Already have an account? <a href="#" id="show-login" class="font-medium text-green-600 hover:underline">Login here</a>
                  </p>
              </div>
              
              <!-- Step 2: OTP Verification -->
              <div id="step-otp" class="hidden">
                  <div class="text-center mb-4">
                      <p class="text-sm text-gray-600">We've sent a verification code to:</p>
                      <p id="email-display" class="font-semibold text-green-700"></p>
                  </div>
                  <label for="otp" class="block mb-2 text-sm font-medium text-gray-900">Enter OTP Code</label>
                  <input type="text" id="otp" class="bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-green-500 focus:border-green-500 block w-full p-2.5 text-center text-xl tracking-widest" placeholder="000000" maxlength="6" autocomplete="off">
                  <button type="button" id="verifyOtpBtn" class="w-full mt-4 text-white bg-gradient-to-r from-green-700 to-green-500 hover:from-green-600 hover:to-green-400 focus:ring-4 focus:outline-none focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center shadow-lg transform transition hover:-translate-y-0.5">Verify OTP</button>
                  <p class="text-center mt-3">
                      <a href="#" id="resendOtp" class="text-sm text-green-600 hover:underline">Resend OTP</a>
                  </p>
              </div>
              
              <!-- Step 3: Password -->
              <div id="step-password" class="hidden">
                  <div class="text-center mb-4">
                      <p class="text-sm text-gray-600">Email verified!</p>
                      <p class="text-xs text-gray-500">Now set your password</p>
                  </div>
                  <label for="password" class="block mb-2 text-sm font-medium text-gray-900">Password</label>
                  <input type="password" id="password" class="bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-green-500 focus:border-green-500 block w-full p-2.5" placeholder="••••••••" required autocomplete="new-password">
                  <label for="confirm-password" class="block mb-2 mt-3 text-sm font-medium text-gray-900">Confirm Password</label>
                  <input type="password" id="confirm-password" class="bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-green-500 focus:border-green-500 block w-full p-2.5" placeholder="••••••••" required autocomplete="new-password">
                  <button type="button" id="registerBtn" class="w-full mt-4 text-white bg-gradient-to-r from-green-700 to-green-500 hover:from-green-600 hover:to-green-400 focus:ring-4 focus:outline-none focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center shadow-lg transform transition hover:-translate-y-0.5">Create Account</button>
              </div>
          </div>

          <!-- Login Section -->
          <div class="p-6 space-y-4 md:space-y-6 sm:p-8" id="login-section" style="display:none;">
              <h1 class="text-xl font-bold leading-tight tracking-tight text-gray-900 md:text-2xl text-center text-green-800">
                  <span class="text-yellow-600">✦</span> StudyMatch CSHSB <span class="text-yellow-600">✦</span>
              </h1>
              <h2 class="text-lg font-semibold text-center text-gray-600 mb-6">Welcome Back</h2>
              
              <div>
                  <label for="login-email" class="block mb-2 text-sm font-medium text-gray-900">Your email</label>
                  <input type="email" id="login-email" class="bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-green-500 focus:border-green-500 block w-full p-2.5" placeholder="your.email@cshsb.edu.ph" required autocomplete="off">
              </div>
              <div>
                  <label for="login-password" class="block mb-2 text-sm font-medium text-gray-900">Password</label>
                  <input type="password" id="login-password" class="bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-green-500 focus:border-green-500 block w-full p-2.5" placeholder="••••••••" required autocomplete="current-password">
              </div>
              <div class="flex items-center justify-between">
                  <div class="flex items-start">
                      <div class="flex items-center h-5">
                          <input id="remember" type="checkbox" class="w-4 h-4 border border-gray-300 rounded bg-gray-50 focus:ring-3 focus:ring-green-300">
                      </div>
                      <div class="ml-3 text-sm">
                          <label for="remember" class="text-gray-500">Remember me</label>
                      </div>
                  </div>
              </div>
              <button type="submit" id="loginBtn" class="w-full text-white bg-gradient-to-r from-green-700 to-green-500 hover:from-green-600 hover:to-green-400 focus:ring-4 focus:outline-none focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center shadow-lg transform transition hover:-translate-y-0.5">Sign In</button>
              <p class="text-sm font-light text-center text-gray-500 dark:text-gray-400">
                  Don't have an account yet? <a href="#" id="show-register" class="font-medium text-green-600 hover:underline">Sign up</a>
              </p>
          </div>
      </div>
  </div>
</section>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
const backendURL = window.location.origin;
let currentEmail = '';

// Email validation function
function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    const invalidPatterns = ['test@test.com', 'example@example.com', '@gmail.com', '@yahoo.com', '@hotmail.com'];
    
    if (!emailRegex.test(email)) {
        return { valid: false, message: "Please enter a valid email address." };
    }
    
    for (const pattern of invalidPatterns) {
        if (email.toLowerCase().includes(pattern)) {
            return { valid: false, message: "Please use your school email." };
        }
    }
    
    return { valid: true };
}

// Auto-login from saved credentials
function autoLogin() {
    const savedEmail = localStorage.getItem('studymatch_email');
    const savedPassword = localStorage.getItem('studymatch_password');
    
    if (savedEmail && savedPassword) {
        $('#login-email').val(savedEmail);
        $('#login-password').val(savedPassword);
        $('#remember').prop('checked', true);
        doLogin(savedEmail, savedPassword);
    }
}

// Check if already logged in
async function checkIfLoggedIn() {
    try {
        const response = await fetch(`${backendURL}/check-session`, {
            method: 'GET',
            credentials: 'include'
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.loggedIn) {
                window.location.replace(data.profileComplete ? '/homepage.html' : '/profile-setup.html');
                return true;
            }
        }
    } catch (error) {
        console.log('Session check failed:', error);
    }
    return false;
}

// Run on page load
document.addEventListener('DOMContentLoaded', function() {
    // Check if coming from role selection
    const signupRole = sessionStorage.getItem('signupRole');
    if (!signupRole && !window.location.search.includes('login')) {
        // No role selected and not explicitly logging in, redirect to role selection
        const isShowingLogin = $('#login-section').is(':visible');
        if (!isShowingLogin) {
            window.location.href = '/role-selection.html';
            return;
        }
    }
    
    checkIfLoggedIn();
    setTimeout(autoLogin, 500);
});

// Toggle between login and register
$('#show-login').click(function(e) {
    e.preventDefault();
    $('#register-section').hide();
    $('#login-section').show();
});

$('#show-register').click(function(e) {
    e.preventDefault();
    $('#login-section').hide();
    $('#register-section').show();
});

// Step 1: Send OTP
$('#sendOtpBtn').on('click', function() {
    const email = $('#email').val().trim();
    
    if (!email) {
        Swal.fire({ icon: 'error', title: 'Email Required', text: 'Please enter your email.' });
        return;
    }
    
    const validation = isValidEmail(email);
    if (!validation.valid) {
        Swal.fire({ icon: 'error', title: 'Invalid Email', text: validation.message });
        return;
    }
    
    $('#loadingOverlay').show();
    currentEmail = email.toLowerCase();
    
    $.ajax({
        type: 'POST',
        url: '/send-code',
        contentType: 'application/json',
        data: JSON.stringify({ email: currentEmail }),
        success: function(response) {
            $('#loadingOverlay').hide();
            if (response.success) {
                $('#step-email').addClass('hidden');
                $('#step-otp').removeClass('hidden');
                $('#email-display').text(currentEmail);
                Swal.fire({ icon: 'success', title: 'OTP Sent!', text: 'Check your email for the verification code.' });
            } else {
                Swal.fire({ icon: 'error', title: 'Error', text: response.message || 'Failed to send OTP.' });
            }
        },
        error: function() {
            $('#loadingOverlay').hide();
            Swal.fire({ icon: 'error', title: 'Error', text: 'An error occurred. Please try again.' });
        }
    });
});

// Resend OTP
$('#resendOtp').on('click', function(e) {
    e.preventDefault();
    $('#sendOtpBtn').click();
});

// Step 2: Verify OTP
$('#verifyOtpBtn').on('click', function() {
    const code = $('#otp').val().trim();
    
    if (!code || code.length !== 6) {
        Swal.fire({ icon: 'error', title: 'Invalid OTP', text: 'Please enter the 6-digit code.' });
        return;
    }
    
    $('#loadingOverlay').show();
    
    $.ajax({
        type: 'POST',
        url: '/verify-code',
        contentType: 'application/json',
        data: JSON.stringify({ email: currentEmail, code: code, isLogin: false }),
        success: function(response) {
            $('#loadingOverlay').hide();
            if (response.success) {
                $('#step-otp').addClass('hidden');
                $('#step-password').removeClass('hidden');
            } else {
                Swal.fire({ icon: 'error', title: 'Verification Failed', text: response.message || 'Invalid code.' });
            }
        },
        error: function() {
            $('#loadingOverlay').hide();
            Swal.fire({ icon: 'error', title: 'Error', text: 'An error occurred. Please try again.' });
        }
    });
});

// Step 3: Register with password
$('#registerBtn').on('click', function() {
    const password = $('#password').val();
    const confirmPassword = $('#confirm-password').val();
    
    if (!password || !confirmPassword) {
        Swal.fire({ icon: 'error', title: 'Password Required', text: 'Please enter and confirm your password.' });
        return;
    }
    
    if (password.length < 6) {
        Swal.fire({ icon: 'error', title: 'Password Too Short', text: 'Password must be at least 6 characters.' });
        return;
    }
    
    if (password !== confirmPassword) {
        Swal.fire({ icon: 'error', title: 'Passwords Don\'t Match', text: 'Please make sure both passwords are the same.' });
        return;
    }
    
    $('#loadingOverlay').show();
    
    // Generate a name from email for registration
    const name = currentEmail.split('@')[0].replace(/[._]/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    
    // Get the signup role from sessionStorage
    const signupRole = sessionStorage.getItem('signupRole') || 'student';
    
    $.ajax({
        type: 'POST',
        url: '/register',
        contentType: 'application/json',
        data: JSON.stringify({ 
            name: name, 
            email: currentEmail, 
            password: password,
            isAdmin: signupRole === 'admin'
        }),
        success: function(response) {
            $('#loadingOverlay').hide();
            if (response.success) {
                // Save credentials if remember me is checked (for registration, always save)
                localStorage.setItem('studymatch_email', currentEmail);
                localStorage.setItem('studymatch_password', password);
                
                // Clear the role from sessionStorage
                sessionStorage.removeItem('signupRole');
                
                Swal.fire({ icon: 'success', title: 'Account Created!', text: 'Redirecting to profile setup...', timer: 1500, showConfirmButton: false })
                .then(() => {
                    window.location.href = '/profile-setup.html';
                });
            } else {
                Swal.fire({ icon: 'error', title: 'Registration Failed', text: response.message });
            }
        },
        error: function() {
            $('#loadingOverlay').hide();
            Swal.fire({ icon: 'error', title: 'Error', text: 'An error occurred. Please try again.' });
        }
    });
});

// Login function
function doLogin(email, password) {
    $('#loadingOverlay').show();
    
    $.ajax({
        type: 'POST',
        url: '/login',
        contentType: 'application/json',
        data: JSON.stringify({ email: email, password: password }),
        success: function(response) {
            $('#loadingOverlay').hide();
            if (response.success) {
                // Save credentials if remember me is checked
                if ($('#remember').is(':checked')) {
                    localStorage.setItem('studymatch_email', email);
                    localStorage.setItem('studymatch_password', password);
                } else {
                    localStorage.removeItem('studymatch_email');
                    localStorage.removeItem('studymatch_password');
                }
                
                window.location.href = '/homepage.html';
            } else {
                Swal.fire({ icon: 'error', title: 'Login Failed', text: response.message });
            }
        },
        error: function() {
            $('#loadingOverlay').hide();
            Swal.fire({ icon: 'error', title: 'Error', text: 'An error occurred. Please try again.' });
        }
    });
}

// Login button click
$('#loginBtn').on('click', function() {
    const email = $('#login-email').val().trim();
    const password = $('#login-password').val();
    
    if (!email || !password) {
        Swal.fire({ icon: 'error', title: 'Missing Information', text: 'Please enter email and password.' });
        return;
    }
    
    doLogin(email, password);
});

// Allow Enter key for login
$('#login-password').on('keypress', function(e) {
    if (e.which === 13) {
        $('#loginBtn').click();
    }
});

// OTP input auto-format
$('#otp').on('input', function() {
    this.value = this.value.replace(/\D/g, '').slice(0, 6);
});
</script>
</body>
</html>
