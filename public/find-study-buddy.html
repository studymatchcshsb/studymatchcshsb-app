<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Find KaStudy</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <div class="dashboard-container">
    <div class="main-content">
      <header class="dashboard-header">
        <div class="header-icons">
          <svg class="icon" onclick="window.location.href='/homepage.html'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
        </div>
        <div class="chats-title">FIND KASTUDY</div>
        <a href="/edit-profile.html" class="header-profile">
          <div class="profile-text">
            <span id="user-name"></span>
            <span id="user-details"></span>
          </div>
          <div class="profile-pic-container">
            <div class="profile-initials" id="profile-initials"></div>
          </div>
        </a>
      </header>

      <main class="dashboard-main">
        <section class="find-study-section">
          <div class="find-study-container">
            <h2>Find Your KaStudy!</h2>
            <p>Get help from students in your grade level</p>

            <div class="selection-grid" id="grade-selection">
              <h3>Select Grade Level:</h3>
              <div class="grid-buttons">
                <button class="grade-btn" data-grade="7">Grade 7</button>
                <button class="grade-btn" data-grade="8">Grade 8</button>
                <button class="grade-btn" data-grade="9">Grade 9</button>
                <button class="grade-btn" data-grade="10">Grade 10</button>
              </div>
            </div>

            <div class="selection-grid" id="subject-selection" style="display: none;">
              <h3>Select Subject:</h3>
              <div class="grid-buttons">
                <button class="subject-btn" data-subject="ENGLISH">ENGLISH</button>
                <button class="subject-btn" data-subject="FILIPINO">FILIPINO</button>
                <button class="subject-btn" data-subject="SCIENCE">SCIENCE</button>
                <button class="subject-btn" data-subject="ESP">ESP</button>
                <button class="subject-btn" data-subject="AP">AP</button>
                <button class="subject-btn" data-subject="ICT">ICT</button>
                <button class="subject-btn" data-subject="MAPEH">MAPEH</button>
              </div>
            </div>

            <div class="confirmation-modal" id="confirmation-modal" style="display: none;">
              <h3>Confirm Your Request</h3>
              <p id="confirmation-text"></p>
              <div class="modal-buttons">
                <button id="confirm-btn">Send Request</button>
                <button id="cancel-btn">Cancel</button>
              </div>
            </div>

            <div class="searching-modal" id="searching-modal" style="display: none;">
              <div class="searching-content">
                <div class="searching-icon">üîç</div>
                <h3>Finding Your KaStudy...</h3>
                <p>Sending help requests to students in your grade</p>
                <div class="loading-spinner"></div>
              </div>
            </div>

            <div id="message" style="margin-top: 20px; text-align: center;"></div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script>
    const backendURL = window.location.origin;
    let selectedGrade = '';
    let selectedSubject = '';

    // Fetch user profile and set initials
    async function fetchUserProfile() {
      try {
        const response = await fetch(`${backendURL}/get-profile`);
        if (!response.ok) {
          throw new Error('Failed to fetch profile');
        }
        const data = await response.json();
        if (data.success) {
          // Set user name and details
          document.getElementById('user-name').innerText = data.user.username;
          document.getElementById('user-details').innerText = `${data.user.grade} - ${data.user.section}`;

          // Set profile initials
          const initials = data.user.username.charAt(0).toUpperCase();
          document.getElementById('profile-initials').innerText = initials;
        }
      } catch (error) {
        console.error("Error fetching profile:", error);
      }
    }

    // Handle grade selection
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('grade-btn')) {
        selectedGrade = e.target.dataset.grade;

        // Remove active class from all grade buttons
        document.querySelectorAll('.grade-btn').forEach(btn => btn.classList.remove('active'));
        // Add active class to selected button
        e.target.classList.add('active');

        // Show subject selection
        document.getElementById('subject-selection').style.display = 'block';
        document.getElementById('grade-selection').scrollIntoView({ behavior: 'smooth' });
      }

      if (e.target.classList.contains('subject-btn')) {
        selectedSubject = e.target.dataset.subject;

        // Remove active class from all subject buttons
        document.querySelectorAll('.subject-btn').forEach(btn => btn.classList.remove('active'));
        // Add active class to selected button
        e.target.classList.add('active');

        // Show confirmation modal
        showConfirmation();
      }

      if (e.target.id === 'confirm-btn') {
        sendHelpRequest();
      }

      if (e.target.id === 'cancel-btn') {
        hideConfirmation();
      }
    });

    function showConfirmation() {
      const confirmationText = document.getElementById('confirmation-text');
      confirmationText.innerHTML = `
        You are about to ask for help with <strong>${selectedSubject}</strong> from students in <strong>Grade ${selectedGrade}</strong>.<br><br>
        This will send a notification to all students in Grade ${selectedGrade} asking if they can help you with ${selectedSubject}.
      `;
      document.getElementById('confirmation-modal').style.display = 'block';
    }

    function hideConfirmation() {
      document.getElementById('confirmation-modal').style.display = 'none';
      // Reset selections
      selectedGrade = '';
      selectedSubject = '';
      document.querySelectorAll('.grade-btn, .subject-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById('subject-selection').style.display = 'none';
    }

    async function sendHelpRequest() {
      document.getElementById('confirmation-modal').style.display = 'none';
      document.getElementById('searching-modal').style.display = 'flex';

      try {
        const response = await fetch(`${backendURL}/send-help-request`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            grade: selectedGrade,
            subject: selectedSubject
          })
        });

        const data = await response.json();

        if (data.success) {
          document.getElementById('searching-modal').innerHTML = `
            <div class="searching-content">
              <div class="success-icon">‚úÖ</div>
              <h3>Request Sent!</h3>
              <p>${data.message}</p>
              <p>You will be notified when someone offers to help.</p>
              <button onclick="window.location.href='/homepage.html'" style="margin-top: 20px;">Go Back Home</button>
            </div>
          `;
        } else {
          throw new Error(data.message);
        }
      } catch (error) {
        console.error("Error sending help request:", error);
        document.getElementById('searching-modal').innerHTML = `
          <div class="searching-content">
            <div class="error-icon">‚ùå</div>
            <h3>Error</h3>
            <p>${error.message}</p>
            <button onclick="location.reload()" style="margin-top: 20px;">Try Again</button>
          </div>
        `;
      }
    }

    // Fetch user profile when the page loads
    document.addEventListener('DOMContentLoaded', function() {
      fetchUserProfile();
    });
  </script>
</body>
</html>