<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Finish Setting Up Profile</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <div class="container">
    <h2>Finish Setting Up Profile</h2>
    <form id="profile-form" onsubmit="prepareAndSubmit(event)">
      <input type="text" id="name" name="name" placeholder="Name (One name, no spaces)" required pattern="[A-Za-z]+" title="Please enter one name without spaces." oninput="capitalizeInput(this)" />
      <input type="text" id="surname" name="surname" placeholder="Surname" required oninput="capitalizeInput(this)" />
      <input type="text" inputmode="numeric" name="lrn" placeholder="LRN (12 digits)" required minlength="12" maxlength="12" pattern="\d{12}" title="Please enter exactly 12 digits for the LRN." />
      
      <select name="grade" required>
        <option value="" disabled selected>Select Your Grade</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
      </select>
      
      <select name="section" required>
        <option value="" disabled selected>Select Your Section</option>
        <option value="Android">Android</option>
        <option value="Oracle">Oracle</option>
        <option value="Symbian">Symbian</option>
        <option value="Macintosh">Macintosh</option>
        <option value="Redhat">Redhat</option>
        <option value="Unix">Unix</option>
        <option value="Fedora">Fedora</option>
        <option value="Minix">Minix</option>
        <option value="Solaris">Solaris</option>
        <option value="Chimera">Chimera</option>
        <option value="Linux">Linux</option>
        <option value="Xenix">Xenix</option>
      </select>
      
      <button type="submit">Next</button>
    </form>
    <p id="form-message" style="color: red;"></p>
  </div>

  <script>
    const backendURL = window.location.origin;

    function capitalizeInput(element) {
      let value = element.value;
      if (value.length > 0) {
        // Capitalize first letter, lowercase the rest
        element.value = value.charAt(0).toUpperCase() + value.slice(1).toLowerCase();
      }
    }

    async function prepareAndSubmit(event) {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);
      const lrn = formData.get('lrn');
      const firstName = formData.get('name');
      const surname = formData.get('surname');
      const messageEl = document.getElementById('form-message');

      messageEl.innerText = "Validating LRN and name...";

      try {
        // First, validate LRN
        const lrnResponse = await fetch(`${backendURL}/check-lrn`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            lrn: lrn,
            firstName: firstName,
            surname: surname
          })
        });

        if (!lrnResponse.ok) {
          const errorData = await lrnResponse.json();
          throw new Error(errorData.message);
        }

        // Get password from URL parameters (passed from index.html)
        const urlParams = new URLSearchParams(window.location.search);
        const password = urlParams.get('password');

        if (!password) {
          throw new Error('Password not found. Please go back and sign up again.');
        }

        messageEl.innerText = "Saving profile...";

        // Prepare profile data
        const profileData = {
          name: formData.get('name').trim(),
          surname: formData.get('surname'),
          lrn: formData.get('lrn'),
          grade: formData.get('grade'),
          section: formData.get('section'),
          password: password
        };

        // Save profile directly
        const saveResponse = await fetch(`${backendURL}/save-profile`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(profileData)
        });

        if (!saveResponse.ok) {
          const errorData = await saveResponse.json();
          throw new Error(errorData.message);
        }

        messageEl.style.color = 'green';
        messageEl.innerText = "Profile saved! Redirecting...";

        // Redirect to homepage after a short delay
        setTimeout(() => {
          window.location.href = "/homepage.html";
        }, 1500);

      } catch (error) {
        messageEl.innerText = error.message;
        messageEl.style.color = 'red';
      }
    }

  </script>
</body>
</html>