<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, minimum-scale=0.5">
  <title>Finish Setting Up Profile</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    .readonly-field {
      background-color: #f0f0f0;
      cursor: not-allowed;
    }
    
    .username-status {
      font-size: 12px;
      margin-top: 5px;
      font-weight: 600;
    }
    
    .username-status.available {
      color: green;
    }
    
    .username-status.taken {
      color: red;
    }
    
    .username-status.checking {
      color: #666;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Finish Setting Up Profile</h2>
    <form id="profile-form" onsubmit="prepareAndSubmit(event)">
      <!-- Step 1: Enter ID Number to lookup student info -->
      <div id="lrn-lookup-step">
        <input type="text" id="lrn-input" inputmode="numeric" placeholder="Enter your ID Number (12 digits)" required minlength="12" maxlength="12" pattern="\d{12}" title="Please enter exactly 12 digits for the ID Number." />
        <button type="button" onclick="lookupLRN()" style="background: linear-gradient(135deg, #4CAF50, #388E3C); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 14px;">Verify ID Number</button>
        <p id="lrn-message" style="color: red;"></p>
      </div>

      <!-- Step 2: Auto-filled fields and username selection -->
      <div id="profile-fields-step" style="display: none;">
        <input type="text" id="name" name="name" placeholder="Name" readonly class="readonly-field" required />
        <input type="text" id="surname" name="surname" placeholder="Surname" readonly class="readonly-field" required />
        <input type="text" id="lrn" name="lrn" placeholder="ID Number" readonly class="readonly-field" required />
        <input type="text" id="grade" name="grade" placeholder="Grade" readonly class="readonly-field" required />
        <input type="text" id="section" name="section" placeholder="Section" readonly class="readonly-field" required />
        
        <input type="text" id="username" name="username" placeholder="Choose your Username/Codename (3-20 characters)" required minlength="3" maxlength="20" pattern="[A-Za-z0-9_]+" title="Username can only contain letters, numbers, and underscores." oninput="checkUsername()" />
        <div id="username-status" class="username-status"></div>
        
        <button type="submit" id="submit-btn" disabled style="background: linear-gradient(135deg, #4CAF50, #388E3C); color: white; border: none; padding: 14px 28px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; width: 100%;">Complete Profile</button>
      </div>
    </form>
    <p id="form-message" style="color: red;"></p>
  </div>

  <script>
    const backendURL = window.location.origin;
    let usernameCheckTimeout;
    let isUsernameValid = false;

    // Profanity filter - comprehensive list of inappropriate words
    const profanityList = [
      'fuck', 'fuk', 'fck', 'fucku', 'fcku', 'fuk u', 'fuck you', 'fuckyou',
      'shit', 'shyt', 'sh1t', 'shitty',
      'ass', 'azz', 'as5', 'a55', 'butt', 'asshole', 
      'bitch', 'b1tch', 'bich', 'bitxh', 'btch',
      'bastard', 'bastrd', 'baster',
      'damn', 'damnit', 'dammit',
      'hell', 'hellno', 'hell no',
      'crap', 'crappy',
      'dick', 'd1ck', 'dik',
      'piss', 'p1ss',
      'cock', 'c0ck', 'cok',
      'cunt', 'c0nt',
      'whore', 'whor3',
      'slut', 'sl1ut', '5lut',
      'gay', 'g4y', 'faggot', 'fagg0t', 'fagot', 'fag',
      'nigger', 'nigga',
      'retard', 'ret1rd', 'retarded',
      'idiot', '1d1ot',
      'stupid', 'st00pid',
      'ugly', 'ug1y',
      'hate', 'hat3',
      'loser', 'l0ser',
      'dumb', 'dumbass',
      'porn', 'p0rn', 'pr0n', 'xxx',
      'sex', 's3x',
      'nude', 'n00d',
      'nipple', 'nipples',
      'vagina', 'vajina', 'pussy', 'pusssy',
      'penis', 'p3nis',
      'boob', 'boobs', 'tits', 'tit',
      'puta', 'putang', 'gago', 'tanga', 'bobo', 'tarantado', 'ulol',
      'tangina', 'punyeta', 'leche', 'yawa', 'piste'
    ];

    // Check if user is authenticated
    async function checkAuthentication() {
      try {
        const response = await fetch(`${backendURL}/check-session`, {
          method: 'GET',
          credentials: 'include'
        });
        const data = await response.json();
        
        if (!data.loggedIn) {
          alert('Session expired. Please sign up or log in again.');
          window.location.href = '/index.html';
        }
      } catch (error) {
        console.error('Error checking authentication:', error);
        alert('Unable to verify authentication. Please try again.');
        window.location.href = '/index.html';
      }
    }

    // Check authentication on page load
    checkAuthentication();

    async function lookupLRN() {
      const lrnInput = document.getElementById('lrn-input');
      const lrn = lrnInput.value.trim();
      const messageEl = document.getElementById('lrn-message');

      if (lrn.length !== 12) {
        messageEl.innerText = "Please enter a valid 12-digit ID Number.";
        messageEl.style.color = 'red';
        return;
      }

      messageEl.innerText = "Verifying LRN...";
      messageEl.style.color = '#666';

      try {
        const response = await fetch(`${backendURL}/lookup-lrn`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ lrn: lrn })
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message);
        }

        const data = await response.json();
        
        if (data.success) {
          // Fill in the form fields
          document.getElementById('name').value = data.student.firstName;
          document.getElementById('surname').value = data.student.surname;
          document.getElementById('lrn').value = data.student.lrn;
          document.getElementById('grade').value = data.student.grade || '';
          document.getElementById('section').value = data.student.section || '';

          // Check if this is an admin
          if (data.student.isAdmin) {
            // For admin, auto-generate username and make it readonly
            const username = data.student.firstName + data.student.surname;
            document.getElementById('username').value = username;
            document.getElementById('username').readOnly = true;
            document.getElementById('username').classList.add('readonly-field');
            document.getElementById('username-status').innerText = '✓ Admin username (auto-generated)';
            document.getElementById('username-status').className = 'username-status available';
            isUsernameValid = true;
            document.getElementById('submit-btn').disabled = false;
            
            // Store teaching subject for admin
            window.adminTeachingSubject = data.student.teachingSubject || null;
          }

          // Hide LRN lookup step and show profile fields
          document.getElementById('lrn-lookup-step').style.display = 'none';
          document.getElementById('profile-fields-step').style.display = 'block';
          
          messageEl.innerText = "";
        }
      } catch (error) {
        messageEl.innerText = error.message;
        messageEl.style.color = 'red';
      }
    }

    function containsProfanity(text) {
      const lowerText = text.toLowerCase();
      return profanityList.some(word => lowerText.includes(word));
    }

    async function checkUsername() {
      const usernameInput = document.getElementById('username');
      const username = usernameInput.value.trim();
      const statusEl = document.getElementById('username-status');
      const submitBtn = document.getElementById('submit-btn');

      // Clear previous timeout
      clearTimeout(usernameCheckTimeout);

      if (username.length < 3) {
        statusEl.innerText = '';
        statusEl.className = 'username-status';
        isUsernameValid = false;
        submitBtn.disabled = true;
        return;
      }

      // Check for profanity
      if (containsProfanity(username)) {
        statusEl.innerText = '❌ Username contains inappropriate language';
        statusEl.className = 'username-status taken';
        isUsernameValid = false;
        submitBtn.disabled = true;
        return;
      }

      statusEl.innerText = '⏳ Checking availability...';
      statusEl.className = 'username-status checking';
      isUsernameValid = false;
      submitBtn.disabled = true;

      // Debounce the API call
      usernameCheckTimeout = setTimeout(async () => {
        try {
          const response = await fetch(`${backendURL}/check-username`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ username: username })
          });

          const data = await response.json();

          if (data.available) {
            statusEl.innerText = '✓ Username is available!';
            statusEl.className = 'username-status available';
            isUsernameValid = true;
            submitBtn.disabled = false;
          } else {
            statusEl.innerText = '❌ Username is already taken';
            statusEl.className = 'username-status taken';
            isUsernameValid = false;
            submitBtn.disabled = true;
          }
        } catch (error) {
          console.error('Error checking username:', error);
          statusEl.innerText = '⚠ Error checking username';
          statusEl.className = 'username-status taken';
          isUsernameValid = false;
          submitBtn.disabled = true;
        }
      }, 500); // Wait 500ms after user stops typing
    }

    async function prepareAndSubmit(event) {
      event.preventDefault();
      
      if (!isUsernameValid) {
        alert('Please choose a valid and available username.');
        return;
      }

      const form = event.target;
      const formData = new FormData(form);
      const messageEl = document.getElementById('form-message');

      messageEl.innerText = "Saving profile...";
      messageEl.style.color = '#666';

      try {
        // Prepare profile data
        const profileData = {
          name: formData.get('name').trim(),
          surname: formData.get('surname').trim(),
          username: formData.get('username').trim(),
          lrn: formData.get('lrn'),
          grade: formData.get('grade'),
          section: formData.get('section'),
          teachingSubject: window.adminTeachingSubject || null
        };

        // Save profile
        const saveResponse = await fetch(`${backendURL}/save-profile`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(profileData)
        });

        if (!saveResponse.ok) {
          const errorData = await saveResponse.json();
          throw new Error(errorData.message);
        }

        messageEl.style.color = 'green';
        messageEl.innerText = "Profile saved! Redirecting...";

        // Redirect to homepage after a short delay
        setTimeout(() => {
          window.location.href = "/homepage.html";
        }, 1500);

      } catch (error) {
        messageEl.innerText = error.message;
        messageEl.style.color = 'red';
      }
    }

  </script>
</body>
</html>
